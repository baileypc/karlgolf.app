<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' data:; font-src 'self' data:; connect-src 'self' https://unpkg.com https://cdn.tailwindcss.com;">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Karl's GIR - Golf Tracker</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#16a34a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Karl's GIR">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="images/karls_gir.png">
    <link rel="apple-touch-icon" href="images/karls_gir.png">
    
    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Using inline SVG icons to avoid CSP violations -->
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #000000;
            color: #e2e8f0;
        }
        
        /* Custom scrollbar for dark green theme */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #142514;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #2d4a2d;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #3d5a3d;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- Pre-React initialization: Ensure login state is set synchronously -->
    <script>
        // Force localStorage check before React renders
        // This ensures buttons show correctly on page load, even from cache
        (function() {
            const stored = localStorage.getItem('karlsGIR_isLoggedIn');
            window.__karlsGIR_initialLoginState = stored === 'true';
            console.log('Pre-React: Initial login state =', window.__karlsGIR_initialLoginState);
        })();
    </script>
    
    <!-- Font Awesome Icons -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Inline SVG Icon Components (CSP-safe)
        const Download = ({ size = 18, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 512 512" fill="currentColor" className={className}>
                <path d="M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32V274.7l-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7V32zM64 352c-35.3 0-64 28.7-64 64v32c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V416c0-35.3-28.7-64-64-64H214.6l-45.3 45.3c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L169.4 352H64zm368 56a24 24 0 1 1 0 48 24 24 0 1 1 0-48z"/>
            </svg>
        );
        
        const RotateCcw = ({ size = 18, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 512 512" fill="currentColor" className={className}>
                <path d="M463.5 224H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1c-87.5 87.5-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5z"/>
            </svg>
        );
        
        const Plus = ({ size = 18, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 448 512" fill="currentColor" className={className}>
                <path d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/>
            </svg>
        );
        
        const Trophy = ({ size = 64, className = "", color = "currentColor" }) => (
            <svg width={size} height={size} viewBox="0 0 576 512" fill={color} className={className}>
                <path d="M400 0H176c-26.5 0-48.1 21.8-47.1 48.2c.2 5.3 .4 10.6 .7 15.8C99.9 88.3 63 130.4 45.6 180.4c-17.4 50-17.4 103.3 0 153.3c17.5 50.3 54.6 92.5 102.2 116.5c47.5 24 103.3 32.5 158.4 25.1c11.5 19.3 31.5 33.7 54.3 33.7H304c17.7 0 32 14.3 32 32s-14.3 32-32 32H240 128c-17.7 0-32 14.3-32 32s14.3 32 32 32H448c17.7 0 32-14.3 32-32s-14.3-32-32-32H352 336c-35.3 0-64-28.7-64-64c0-6.9 1.1-13.6 3.1-20c-55.3 7.4-111.2-1.1-158.8-25.1c-47.6-24-84.7-66.2-102.2-116.5c-17.4-50-17.4-103.3 0-153.3c17.3-49.9 54.2-92 83.9-116.7c.3-5.2 .5-10.4 .7-15.7C176.1 21.8 197.5 0 224 0H400z"/>
            </svg>
        );
        
        const Party = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 576 512" fill="currentColor" className={className}>
                <path d="M32 32C14.3 32 0 46.3 0 64S14.3 96 32 96V256c0 53 43 96 96 96v32c0 17.7 14.3 32 32 32h32c17.7 0 32-14.3 32-32V352c53 0 96-43 96-96V96c17.7 0 32-14.3 32-32s-14.3-32-32-32H32zm448 0c-17.7 0-32 14.3-32 32s14.3 32 32 32v32c0 17.7 14.3 32 32 32s32-14.3 32-32V96c17.7 0 32-14.3 32-32s-14.3-32-32-32H480zM96 288c-17.7 0-32-14.3-32-32V224c0-17.7 14.3-32 32-32s32 14.3 32 32v32c0 17.7-14.3 32-32 32zm352-32V224c0-17.7 14.3-32 32-32s32 14.3 32 32v32c0 17.7-14.3 32-32 32s-32-14.3-32-32zm-96 64v32c0 17.7 14.3 32 32 32s32-14.3 32-32V320c0-17.7-14.3-32-32-32s-32 14.3-32 32zM544 224v32c0 17.7 14.3 32 32 32s32-14.3 32-32V224c0-17.7-14.3-32-32-32s-32 14.3-32 32zM160 480c0 17.7 14.3 32 32 32H384c17.7 0 32-14.3 32-32s-14.3-32-32-32H192c-17.7 0-32 14.3-32 32z"/>
            </svg>
        );
        
        const CheckCircle = ({ size = 64, className = "", color = "currentColor" }) => (
            <svg width={size} height={size} viewBox="0 0 512 512" fill={color} className={className}>
                <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/>
            </svg>
        );
        
        const Chart = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 512 512" fill="currentColor" className={className}>
                <path d="M32 32c17.7 0 32 14.3 32 32V400c0 8.8 7.2 16 16 16H480c17.7 0 32 14.3 32 32s-14.3 32-32 32H80c-44.2 0-80-35.8-80-80V64C0 46.3 14.3 32 32 32zm96 96c0-17.7 14.3-32 32-32s32 14.3 32 32V352c0 17.7-14.3 32-32 32s-32-14.3-32-32V128zm128-32c17.7 0 32 14.3 32 32V352c0 17.7-14.3 32-32 32s-32-14.3-32-32V128c0-17.7 14.3-32 32-32zm128 64c17.7 0 32 14.3 32 32V352c0 17.7-14.3 32-32 32s-32-14.3-32-32V192c0-17.7 14.3-32 32-32z"/>
            </svg>
        );
        
        const LocationPin = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 384 512" fill="currentColor" className={className}>
                <path d="M215.7 499.2C267 435 384 279.4 384 192C384 86 298 0 192 0S0 86 0 192c0 87.4 117 243 168.3 307.2c12.3 15.3 35.1 15.3 47.4 0zM192 128a64 64 0 1 1 0 128 64 64 0 1 1 0-128z"/>
            </svg>
        );
        
        const Lightbulb = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 384 512" fill="currentColor" className={className}>
                <path d="M272 384c9.6-31.9 29.5-59.1 49.2-86.2l0 0c5.2-7.1 10.4-14.2 15.4-21.4c19.8-28.5 31.4-63 31.4-100.3C368 78.8 289.2 0 192 0S16 78.8 16 176c0 37.3 11.6 71.9 31.4 100.3c5 7.2 10.2 14.3 15.4 21.4l0 0c19.8 27.1 39.7 54.4 49.2 86.2H272zM192 512c44.2 0 80-35.8 80-80V416H112v16c0 44.2 35.8 80 80 80zM112 176c0 8.8-7.2 16-16 16s-16-7.2-16-16c0-61.9 50.1-112 112-112c8.8 0 16 7.2 16 16s-7.2 16-16 16c-44.2 0-80 35.8-80 80z"/>
            </svg>
        );
        
        const Star = ({ size = 16, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 576 512" fill="currentColor" className={className}>
                <path d="M287.9 0c9.2 0 17.6 5.2 21.6 13.5l68.6 141.3 153.2 22.6c9 1.3 16.5 7.6 19.3 16.3s.5 18.1-5.9 24.5L433.6 328.4l26.2 155.6c1.5 9-2.2 18.1-9.6 23.5s-17.3 6-25.3 1.7l-137-73.2L151 509.1c-8.1 4.3-17.9 3.7-25.3-1.7s-11.2-14.5-9.7-23.5l26.2-155.6L31.1 218.2c-6.5-6.4-8.7-15.9-5.9-24.5s10.3-14.9 19.3-16.3l153.2-22.6L266.3 13.5C270.4 5.2 278.7 0 287.9 0zm0 79L235 174.2 99.5 191.4l63.5 62 15 87.6 78.5-41.4 78.5 41.4 15-87.6 63.4-62L340.6 174 287.9 79z"/>
            </svg>
        );
        
        const Warning = ({ size = 16, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 512 512" fill="currentColor" className={className}>
                <path d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/>
            </svg>
        );

        // Main App Component
        function GolfGIRTracker() {
            const [holes, setHoles] = useState([]);
            const [currentHole, setCurrentHole] = useState(1);
            const [showResetModal, setShowResetModal] = useState(false);
            const [showValidationModal, setShowValidationModal] = useState(false);
            const [validationMessage, setValidationMessage] = useState('Please fill in all required fields before submitting.');
            const [showEmailModal, setShowEmailModal] = useState(false);
            const [emailModalType, setEmailModalType] = useState(''); // '9hole' or '18hole'
            const [userEmail, setUserEmail] = useState('');
            const [emailSending, setEmailSending] = useState(false);
            const [emailSent, setEmailSent] = useState(false);
            // Initialize login state - check global variable first (set synchronously before React)
            // Then fallback to localStorage (in case global wasn't set)
            const [isLoggedIn, setIsLoggedIn] = useState(() => {
                const fromGlobal = window.__karlsGIR_initialLoginState !== undefined 
                    ? window.__karlsGIR_initialLoginState 
                    : null;
                const fromStorage = localStorage.getItem('karlsGIR_isLoggedIn') === 'true';
                const isLoggedIn = fromGlobal !== null ? fromGlobal : fromStorage;
                console.log('Initial login state - Global:', fromGlobal, 'Storage:', fromStorage, 'Final:', isLoggedIn);
                return isLoggedIn;
            });
            const [savingRound, setSavingRound] = useState(false);
            const [roundSaved, setRoundSaved] = useState(false);
            const [savedHolesCount, setSavedHolesCount] = useState(0); // Track how many holes were saved
            const [showCreateAccountPrompt, setShowCreateAccountPrompt] = useState(false);
            const [previousLoginState, setPreviousLoginState] = useState(isLoggedIn);
            const [courseName, setCourseName] = useState('');
            const [showCourseNameModal, setShowCourseNameModal] = useState(false);
            const [showMergeRoundModal, setShowMergeRoundModal] = useState(false);
            const [incompleteRounds, setIncompleteRounds] = useState([]);
            const [mergeIntoRoundId, setMergeIntoRoundId] = useState(null);
            const [existingCourseNames, setExistingCourseNames] = useState([]);

            // Check login status on mount and after navigation - with periodic checks
            useEffect(() => {
                let mounted = true;
                
                // Check if this is a logout redirect (URL has timestamp parameter)
                const urlParams = new URLSearchParams(window.location.search);
                const isLoginRedirect = urlParams.has('t');
                
                // If coming from logout, immediately check localStorage and clear any stale state
                // CRITICAL: Prioritize localStorage over server check for logout redirects
                if (isLoginRedirect) {
                    const localStorageLogin = localStorage.getItem('karlsGIR_isLoggedIn') === 'true';
                    if (!localStorageLogin) {
                        // localStorage says logged out, update state immediately and skip server check
                        setIsLoggedIn(false);
                        console.log('Immediate logout state update from localStorage (skip server check)');
                        return; // Exit early - don't run server check
                    }
                }
                
                const checkLoginStatus = async () => {
                    if (!mounted) return;
                    
                    // CRITICAL: Before server check, if localStorage says logged out, trust it immediately
                    const localStorageLogin = localStorage.getItem('karlsGIR_isLoggedIn') === 'true';
                    if (!localStorageLogin && isLoggedIn) {
                        // localStorage says logged out but state says logged in - trust localStorage
                        console.log('localStorage says logged out, updating state immediately');
                        setIsLoggedIn(false);
                        return; // Don't even check server - localStorage is source of truth after logout
                    }
                    
                    try {
                        const res = await fetch('auth.php?action=check&_=' + Date.now(), {
                            credentials: 'include',
                            cache: 'no-store',
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache',
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });
                        
                        if (!res.ok) {
                            console.error('Auth check failed:', res.status, res.statusText);
                            // On error, check localStorage as fallback
                            const localStorageLogin = localStorage.getItem('karlsGIR_isLoggedIn') === 'true';
                            if (mounted) {
                                setIsLoggedIn(localStorageLogin);
                            }
                            return;
                        }
                        
                        const text = await res.text();
                        if (!text || text.trim() === '') {
                            console.error('Empty response from auth.php');
                            // On empty response, check localStorage as fallback
                            const localStorageLogin = localStorage.getItem('karlsGIR_isLoggedIn') === 'true';
                            if (mounted) {
                                setIsLoggedIn(localStorageLogin);
                            }
                            return;
                        }
                        
                        let data;
                        try {
                            data = JSON.parse(text);
                        } catch (e) {
                            console.error('Invalid JSON response:', text);
                            // On parse error, check localStorage as fallback
                            const localStorageLogin = localStorage.getItem('karlsGIR_isLoggedIn') === 'true';
                            if (mounted) {
                                setIsLoggedIn(localStorageLogin);
                            }
                            return;
                        }
                        
                        const newLoginState = data.loggedIn === true;
                        
                        // CRITICAL: If localStorage says logged out, trust it over server response
                        // This handles cases where server session hasn't fully cleared yet
                        if (!localStorageLogin && newLoginState) {
                            console.log('Server says logged in but localStorage says logged out - trusting localStorage');
                            if (mounted) {
                                setIsLoggedIn(false);
                            }
                            return;
                        }
                        
                        if (mounted) {
                            setIsLoggedIn(prev => {
                                if (prev !== newLoginState) {
                                    console.log('Login state changed from', prev, 'to', newLoginState);
                                    // Store previous state to detect logout
                                    setPreviousLoginState(prev);
                                    // Store in localStorage as backup
                                    localStorage.setItem('karlsGIR_isLoggedIn', newLoginState ? 'true' : 'false');
                                    
                                    // If user just logged out and has holes, show the banner
                                    if (prev === true && newLoginState === false && holes.length > 0) {
                                        setShowCreateAccountPrompt(true);
                                    }
                                }
                                return newLoginState;
                            });
                        }
                    } catch (err) {
                        console.error('Error checking login:', err);
                        // On error, check localStorage as fallback
                        const localStorageLogin = localStorage.getItem('karlsGIR_isLoggedIn') === 'true';
                        if (mounted) {
                            setIsLoggedIn(localStorageLogin);
                        }
                    }
                };
                
                // Force immediate sync from localStorage BEFORE server check
                // CRITICAL: If localStorage says logged out, trust it immediately (especially after logout)
                const storedLoginState = localStorage.getItem('karlsGIR_isLoggedIn') === 'true';
                if (!storedLoginState && isLoggedIn) {
                    // localStorage says logged out but React state says logged in - trust localStorage
                    console.log('localStorage says logged out, immediately updating React state');
                    setPreviousLoginState(isLoggedIn);
                    setIsLoggedIn(false);
                    // Don't run server check if localStorage says logged out
                    return;
                }
                if (storedLoginState !== isLoggedIn) {
                    // Store previous state before updating
                    setPreviousLoginState(isLoggedIn);
                    // Force immediate update from localStorage - this ensures buttons show correctly
                    console.log('Syncing login state from localStorage:', storedLoginState);
                    setIsLoggedIn(storedLoginState);
                    
                    // If user just logged out (was logged in, now not) and has holes, show banner
                    if (isLoggedIn === true && storedLoginState === false && holes.length > 0) {
                        setShowCreateAccountPrompt(true);
                    }
                }
                
                // Also check server to verify
                checkLoginStatus();
                
                // Listen for localStorage changes to update state immediately
                const handleStorageChange = (e) => {
                    if (e.key === 'karlsGIR_isLoggedIn' && mounted) {
                        const newState = e.newValue === 'true';
                        setIsLoggedIn(newState);
                        console.log('Login state updated from localStorage:', newState);
                    }
                };
                window.addEventListener('storage', handleStorageChange);
                
                // Also check localStorage periodically (for same-tab changes)
                const localStorageCheck = setInterval(() => {
                    if (mounted) {
                        const currentStored = localStorage.getItem('karlsGIR_isLoggedIn') === 'true';
                        setIsLoggedIn(prev => {
                            if (prev !== currentStored) {
                                console.log('Login state sync from localStorage:', currentStored);
                                return currentStored;
                            }
                            return prev;
                        });
                    }
                }, 500);
                
                // Use interval for more reliable checking (isLoginRedirect already defined above)
                let intervalId = null;
                if (isLoginRedirect) {
                    // Very aggressive checking after login redirect - check every 100ms for 5 seconds
                    intervalId = setInterval(() => {
                        if (mounted) {
                            checkLoginStatus();
                        }
                    }, 100);
                    
                    // Stop interval after 5 seconds
                    setTimeout(() => {
                        if (intervalId) {
                            clearInterval(intervalId);
                            intervalId = null;
                        }
                    }, 5000);
                }
                
                // Periodic check every 2 seconds while page is active (to catch navigation changes)
                const periodicCheck = setInterval(() => {
                    if (mounted && document.visibilityState === 'visible') {
                        checkLoginStatus();
                    }
                }, 2000);
                
                // Check multiple times after redirect to ensure session cookie is set
                const timers = [
                    setTimeout(checkLoginStatus, 100),
                    setTimeout(checkLoginStatus, 300),
                    setTimeout(checkLoginStatus, 500),
                    setTimeout(checkLoginStatus, 1000),
                    setTimeout(checkLoginStatus, 2000)
                ];
                
                // If URL has a timestamp parameter (from login redirect), force more checks
                if (isLoginRedirect) {
                    // More aggressive checks for login redirect
                    const additionalTimers = [
                        setTimeout(checkLoginStatus, 50),
                        setTimeout(checkLoginStatus, 150),
                        setTimeout(checkLoginStatus, 250),
                        setTimeout(checkLoginStatus, 400),
                        setTimeout(checkLoginStatus, 600),
                        setTimeout(checkLoginStatus, 800),
                        setTimeout(checkLoginStatus, 1200),
                        setTimeout(checkLoginStatus, 2000),
                        setTimeout(checkLoginStatus, 3000),
                        setTimeout(checkLoginStatus, 4000)
                    ];
                    timers.push(...additionalTimers);
                    // Clean up URL after checks
                    setTimeout(() => {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }, 2000);
                }
                
                // Also check when page becomes visible (in case user switched tabs or navigated back)
                const handleVisibilityChange = () => {
                    if (document.visibilityState === 'visible' && mounted) {
                        // Immediate check when page becomes visible
                        checkLoginStatus();
                    }
                };
                document.addEventListener('visibilitychange', handleVisibilityChange);
                
                // Also check on window focus (helps with browser back/forward)
                const handleFocus = () => {
                    if (mounted) {
                        checkLoginStatus();
                    }
                };
                window.addEventListener('focus', handleFocus);
                
                // Check on pageshow event (fires when page is loaded from cache/back button)
                const handlePageShow = (e) => {
                    if (mounted) {
                        // Always check on pageshow, not just if persisted
                        checkLoginStatus();
                    }
                };
                window.addEventListener('pageshow', handlePageShow);
                
                // Check when clicking links (before navigation)
                const handleClick = (e) => {
                    // If clicking a link to dashboard or home, check login before navigation
                    const target = e.target.closest('a');
                    if (target && (target.href.includes('dashboard.html') || target.href.includes('index.html'))) {
                        checkLoginStatus();
                    }
                };
                document.addEventListener('click', handleClick, true);
                
                return () => {
                    mounted = false;
                    timers.forEach(timer => clearTimeout(timer));
                    if (intervalId) {
                        clearInterval(intervalId);
                    }
                    clearInterval(periodicCheck);
                    clearInterval(localStorageCheck);
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                    window.removeEventListener('focus', handleFocus);
                    window.removeEventListener('pageshow', handlePageShow);
                    window.removeEventListener('storage', handleStorageChange);
                    document.removeEventListener('click', handleClick, true);
                };
            }, []); // Empty dependency array - only run on mount

            // Load saved rounds from localStorage and server on mount
            // IMPORTANT: This works for both logged in and logged out users
            // This ensures rounds are preserved even if user logs out
            useEffect(() => {
                if (isLoggedIn) {
                    // Check for pending registration data (after account creation)
                    const pendingRegistration = localStorage.getItem('karlsGIR_pendingRegistration');
                    if (pendingRegistration) {
                        try {
                            const data = JSON.parse(pendingRegistration);
                            setHoles(data.holes || []);
                            setCurrentHole(data.currentHole || 1);
                            // Clear the pending registration flag
                            localStorage.removeItem('karlsGIR_pendingRegistration');
                            // Save to regular current round storage
                            localStorage.setItem('karlsGIR_currentRound', JSON.stringify({
                                holes: data.holes || [],
                                currentHole: data.currentHole || 1,
                                lastUpdated: new Date().toISOString()
                            }));
                            return;
                        } catch (e) {
                            console.error('Error loading pending registration data:', e);
                        }
                    }
                    
                    // Check for pending login data (after login)
                    const pendingLogin = localStorage.getItem('karlsGIR_pendingLogin');
                    if (pendingLogin) {
                        try {
                            const data = JSON.parse(pendingLogin);
                            setHoles(data.holes || []);
                            setCurrentHole(data.currentHole || 1);
                            // Clear the pending login flag
                            localStorage.removeItem('karlsGIR_pendingLogin');
                            // Save to regular current round storage
                            localStorage.setItem('karlsGIR_currentRound', JSON.stringify({
                                holes: data.holes || [],
                                currentHole: data.currentHole || 1,
                                lastUpdated: new Date().toISOString()
                            }));
                            return;
                        } catch (e) {
                            console.error('Error loading pending login data:', e);
                        }
                    }
                    
                    // Try to load from server first (for cross-device sync)
                    console.log('Attempting to load current round from server...');
                    fetch('sync-current-round.php?action=get', {
                        credentials: 'include',
                        cache: 'no-store'
                    })
                    .then(res => {
                        console.log('Server response status:', res.status);
                        return res.json();
                    })
                    .then(serverData => {
                        console.log('Server response data:', serverData);
                        if (serverData.success && serverData.holes && serverData.holes.length > 0) {
                            // Server has data - use it (it's the most recent)
                            setHoles(serverData.holes || []);
                            setCurrentHole(serverData.currentHole || 1);
                            // Also update localStorage
                            localStorage.setItem('karlsGIR_currentRound', JSON.stringify({
                                holes: serverData.holes || [],
                                currentHole: serverData.currentHole || 1,
                                lastUpdated: serverData.lastUpdated || new Date().toISOString()
                            }));
                            console.log('✓ Loaded', serverData.holes.length, 'holes from server (cross-device sync)');
                        } else {
                            console.log('No server data found, checking localStorage...');
                            // No server data, check localStorage
                            const saved = localStorage.getItem('karlsGIR_currentRound');
                            if (saved) {
                                try {
                                    const data = JSON.parse(saved);
                                    if (data.holes && data.holes.length > 0) {
                                        setHoles(data.holes || []);
                                        setCurrentHole(data.currentHole || 1);
                                        console.log('✓ Loaded', data.holes.length, 'holes from localStorage');
                                        // Sync to server for future cross-device access
                                        fetch('sync-current-round.php', {
                                            method: 'POST',
                                            credentials: 'include',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({
                                                holes: data.holes,
                                                currentHole: data.currentHole
                                            })
                                        }).then(res => res.json())
                                        .then(result => {
                                            if (result.success) {
                                                console.log('✓ Synced localStorage data to server for cross-device access');
                                            } else {
                                                console.log('⚠ Sync to server failed:', result.message);
                                            }
                                        })
                                        .catch(err => console.log('⚠ Sync to server failed:', err));
                                    } else {
                                        console.log('localStorage has no holes data');
                                    }
                                } catch (e) {
                                    console.error('Error loading saved round:', e);
                                }
                            } else {
                                console.log('No data found in localStorage either');
                            }
                        }
                    })
                    .catch(err => {
                        console.log('⚠ Error loading from server, using localStorage:', err);
                        // Fallback to localStorage
                        const saved = localStorage.getItem('karlsGIR_currentRound');
                        if (saved) {
                            try {
                                const data = JSON.parse(saved);
                                if (data.holes && data.holes.length > 0) {
                                    setHoles(data.holes || []);
                                    setCurrentHole(data.currentHole || 1);
                                    console.log('✓ Loaded', data.holes.length, 'holes from localStorage (fallback)');
                                } else {
                                    console.log('localStorage has no holes data');
                                }
                            } catch (e) {
                                console.error('Error loading saved round:', e);
                            }
                        } else {
                            console.log('No data found in localStorage (fallback)');
                        }
                    });
                } else {
                    // Not logged in - only use localStorage
                    const saved = localStorage.getItem('karlsGIR_currentRound');
                    if (saved) {
                        try {
                            const data = JSON.parse(saved);
                            if (data.holes && data.holes.length > 0) {
                                setHoles(data.holes || []);
                                setCurrentHole(data.currentHole || 1);
                                console.log('Restored', data.holes.length, 'holes from saved round data' + (data.savedOnLogout ? ' (saved on logout)' : ''));
                            }
                        } catch (e) {
                            console.error('Error loading saved round:', e);
                        }
                    }
                }
            }, [isLoggedIn]);

            // Save to localStorage whenever holes change
            useEffect(() => {
                if (holes.length > 0) {
                    localStorage.setItem('karlsGIR_currentRound', JSON.stringify({
                        holes,
                        currentHole,
                        lastUpdated: new Date().toISOString()
                    }));
                    
                    // Also sync to server if logged in (for cross-device access)
                    if (isLoggedIn) {
                        fetch('sync-current-round.php', {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                holes,
                                currentHole
                            })
                        }).catch(err => {
                            // Silently fail - localStorage is the backup
                            console.log('Sync to server failed (using localStorage backup):', err);
                        });
                    }
                }
            }, [holes, currentHole, isLoggedIn]);

            const addHole = (data) => {
                const newHoles = [...holes, { holeNumber: currentHole, ...data }];
                setHoles(newHoles);
                const nextHole = currentHole + 1;
                setCurrentHole(nextHole);
                
                // Show create account prompt if:
                // User is not logged in AND has holes (either first hole or logged out with existing holes)
                if (!isLoggedIn && newHoles.length > 0) {
                    setShowCreateAccountPrompt(true);
                }
                
                // Check if user just completed hole 9 or 18
                if (currentHole === 9 || currentHole === 18) {
                    setEmailModalType(currentHole === 9 ? '9hole' : '18hole');
                    setShowEmailModal(true);
                    setEmailSent(false);
                }
            };

            const deleteHole = (index) => {
                setHoles(holes.filter((_, i) => i !== index));
            };

            const confirmReset = () => {
                setHoles([]);
                setCurrentHole(1);
                localStorage.removeItem('karlsGIR_currentRound');
                // Also clear from server if logged in
                if (isLoggedIn) {
                    fetch('sync-current-round.php?action=delete', {
                        method: 'DELETE',
                        credentials: 'include'
                    }).catch(err => console.log('Error clearing server round:', err));
                }
                setShowResetModal(false);
            };

            const sendEmail = async () => {
                if (!userEmail || !userEmail.includes('@')) {
                    setValidationMessage('Please enter a valid email address.');
                    setShowValidationModal(true);
                    return;
                }

                setEmailSending(true);

                try {
                    // Prepare round data
                    const totalPar = holes.reduce((sum, h) => sum + h.par, 0);
                    const totalScore = holes.reduce((sum, h) => sum + h.score, 0);
                    const totalToPar = totalScore - totalPar;
                    const girsHit = holes.filter(h => h.gir).length;
                    const fairwaysHit = holes.filter(h => h.fairway && h.par !== 3).length;
                    const eligibleFairways = holes.filter(h => h.par !== 3).length;
                    const totalPutts = holes.reduce((sum, h) => sum + h.putts, 0);
                    
                    // Auto-calculate scrambling: par or better when GIR missed
                    const missedGirs = holes.filter(h => !h.gir);
                    const scrambles = missedGirs.filter(h => h.score <= h.par).length;
                    
                    const penalties = holes.filter(h => h.penalty && h.penalty !== '').length;
                    const totalPenaltyStrokes = holes.reduce((sum, h) => {
                        if (h.penalty === 'wrong') return sum + 2;
                        if (h.penalty && h.penalty !== '') return sum + 1;
                        return sum;
                    }, 0);
                    
                    // Calculate putts per GIR
                    const girHoles = holes.filter(h => h.gir);
                    const puttsOnGIR = girHoles.reduce((sum, h) => sum + h.putts, 0);
                    const puttsPerGIR = girHoles.length > 0 ? (puttsOnGIR / girHoles.length).toFixed(2) : 0;
                    
                    // Calculate proximity
                    const allApproaches = holes.filter(h => h.approachDistance);
                    const avgProximity = allApproaches.length > 0 
                        ? (allApproaches.reduce((sum, h) => sum + h.approachDistance, 0) / allApproaches.length).toFixed(1)
                        : 0;

                    const response = await fetch('send-email.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: userEmail,
                            roundType: emailModalType,
                            holes: holes,
                            stats: {
                                totalHoles: holes.length,
                                totalScore,
                                totalPar,
                                toPar: totalToPar,
                                girsHit,
                                totalGirs: holes.length,
                                avgProximity,
                                fairwaysHit,
                                eligibleFairways,
                                totalPutts,
                                avgPutts: (totalPutts / holes.length).toFixed(2),
                                puttsPerGIR,
                                scrambles,
                                missedGirs: missedGirs.length,
                                penalties,
                                totalPenaltyStrokes
                            }
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        setEmailSent(true);
                        setTimeout(() => {
                            setShowEmailModal(false);
                            setUserEmail('');
                        }, 2000);
                    } else {
                        alert('Error sending email: ' + result.message);
                    }
                } catch (error) {
                    alert('Error sending email. Please try again.');
                    console.error('Email error:', error);
                } finally {
                    setEmailSending(false);
                }
            };

            const skipEmail = () => {
                setShowEmailModal(false);
                setUserEmail('');
                setEmailSent(false);
            };

            const checkIncompleteRounds = async (courseNameToCheck = '') => {
                try {
                    const url = courseNameToCheck 
                        ? `get-incomplete-rounds.php?courseName=${encodeURIComponent(courseNameToCheck)}`
                        : 'get-incomplete-rounds.php';
                    const response = await fetch(url, {
                        credentials: 'include',
                        cache: 'no-store'
                    });
                    const data = await response.json();
                    if (data.success && data.incompleteRounds && data.incompleteRounds.length > 0) {
                        setIncompleteRounds(data.incompleteRounds);
                        return data.incompleteRounds;
                    }
                    return [];
                } catch (error) {
                    console.error('Error checking incomplete rounds:', error);
                    return [];
                }
            };

            const loadCourseNames = async () => {
                try {
                    const response = await fetch('get-course-names.php', {
                        credentials: 'include',
                        cache: 'no-store'
                    });
                    const data = await response.json();
                    if (data.success && data.courseNames) {
                        setExistingCourseNames(data.courseNames);
                        return data.courseNames;
                    }
                    return [];
                } catch (error) {
                    console.error('Error loading course names:', error);
                    return [];
                }
            };

            const handleSaveRoundClick = async () => {
                // Load existing course names for the dropdown
                await loadCourseNames();
                
                // Always show course name modal first
                // After they enter/select a course name, we'll check if there's a matching incomplete round
                setShowCourseNameModal(true);
            };

            const saveRound = async () => {
                if (holes.length === 0) return;

                setSavingRound(true);
                setRoundSaved(false);
                setShowCourseNameModal(false);
                setShowMergeRoundModal(false);

                try {
                    // Require course name - never allow "Unnamed Course"
                    // If merging, the course name should already be set from the incomplete round
                    let finalCourseName = courseName.trim();
                    
                    // If merging and course name is empty, get it from the incomplete round
                    if (!finalCourseName && mergeIntoRoundId !== null && incompleteRounds.length > 0) {
                        finalCourseName = incompleteRounds[0].courseName;
                        setCourseName(finalCourseName); // Update state for consistency
                    }
                    
                    if (!finalCourseName) {
                        alert('Course name is required');
                        setSavingRound(false);
                        setShowCourseNameModal(true);
                        return;
                    }
                    
                    const holeCount = holes.length;
                    const isCompleteRound = (holeCount === 9 || holeCount === 18);
                    
                    // Calculate stats (same as email export)
                    const totalPar = holes.reduce((sum, h) => sum + h.par, 0);
                    const totalScore = holes.reduce((sum, h) => sum + h.score, 0);
                    const totalToPar = totalScore - totalPar;
                    const girsHit = holes.filter(h => h.gir).length;
                    const fairwaysHit = holes.filter(h => h.fairway && h.par !== 3).length;
                    const eligibleFairways = holes.filter(h => h.par !== 3).length;
                    const totalPutts = holes.reduce((sum, h) => sum + h.putts, 0);
                    
                    const missedGirs = holes.filter(h => !h.gir);
                    const scrambles = missedGirs.filter(h => h.score <= h.par).length;
                    
                    const penalties = holes.filter(h => h.penalty && h.penalty !== '').length;
                    const totalPenaltyStrokes = holes.reduce((sum, h) => {
                        if (h.penalty === 'wrong') return sum + 2;
                        if (h.penalty && h.penalty !== '') return sum + 1;
                        return sum;
                    }, 0);
                    
                    const girHoles = holes.filter(h => h.gir);
                    const puttsOnGIR = girHoles.reduce((sum, h) => sum + h.putts, 0);
                    const puttsPerGIR = girHoles.length > 0 ? (puttsOnGIR / girHoles.length).toFixed(2) : 0;
                    
                    const allApproaches = holes.filter(h => h.approachDistance);
                    const avgProximity = allApproaches.length > 0 
                        ? (allApproaches.reduce((sum, h) => sum + h.approachDistance, 0) / allApproaches.length).toFixed(1)
                        : 0;

                    // Use the mergeIntoRoundId if explicitly set (from merge modal)
                    // Don't auto-merge here - let the user choose via the modal
                    const finalMergeId = mergeIntoRoundId;
                    
                    console.log('Saving round with:', {
                        holesCount: holes.length,
                        courseName: finalCourseName,
                        mergeIntoRoundId: finalMergeId,
                        isMerging: finalMergeId !== null
                    });
                    
                    const response = await fetch('save-round.php', {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            holes: holes,
                            courseName: finalCourseName,
                            mergeIntoRoundId: finalMergeId !== null ? finalMergeId : undefined,
                            stats: {
                                totalHoles: holes.length,
                                totalScore,
                                totalPar,
                                toPar: totalToPar,
                                girsHit,
                                totalGirs: holes.length,
                                avgProximity,
                                fairwaysHit,
                                eligibleFairways,
                                totalPutts,
                                avgPutts: (totalPutts / holes.length).toFixed(2),
                                puttsPerGIR,
                                scrambles,
                                missedGirs: missedGirs.length,
                                penalties,
                                totalPenaltyStrokes
                            }
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        setRoundSaved(true);
                        // If merged, update savedHolesCount to the merged total; otherwise current count
                        setSavedHolesCount(result.merged ? result.totalHoles : holes.length);
                        setCourseName(''); // Clear course name after saving
                        setShowCourseNameModal(false); // Close modal
                        setMergeIntoRoundId(null); // Clear merge flag
                        
                        // Clear current round from server only if it's a complete round (9 or 18 holes)
                        const isComplete = (holes.length === 9 || holes.length === 18);
                        if (isComplete) {
                            fetch('sync-current-round.php?action=delete', {
                                method: 'DELETE',
                                credentials: 'include'
                            }).catch(err => console.log('Error clearing server current round:', err));
                        }
                        
                        // Reset saved state after 3 seconds (for button feedback)
                        setTimeout(() => {
                            setRoundSaved(false);
                        }, 3000);
                    } else {
                        alert('Error saving round: ' + result.message);
                    }
                } catch (error) {
                    alert('Error saving round. Please try again.');
                    console.error('Save round error:', error);
                } finally {
                    setSavingRound(false);
                }
            };

            const exportData = () => {
                const csv = holes.map(h => {
                    const toPar = h.score - h.par;
                    const toParStr = toPar === 0 ? 'E' : (toPar > 0 ? `+${toPar}` : `-${Math.abs(toPar)}`);
                    const scrambled = !h.gir && h.score <= h.par;
                    return `${h.holeNumber},${h.par},${h.score},${toParStr},${h.gir ? 'Yes' : 'No'},${h.putts},${h.fairway !== null ? (h.fairway ? 'Yes' : 'No') : 'N/A'},${h.approachDistance || ''},${h.penalty || 'None'},${scrambled ? 'Yes' : 'No'}`;
                }).join('\n');
                
                const header = 'Hole,Par,Score,To Par,GIR,Putts,Fairway,Approach Dist (ft),Penalty,Scrambled\n';
                
                // Calculate summary stats
                const totalPar = holes.reduce((sum, h) => sum + h.par, 0);
                const totalScore = holes.reduce((sum, h) => sum + h.score, 0);
                const totalToPar = totalScore - totalPar;
                const girsHit = holes.filter(h => h.gir).length;
                const fairwaysHit = holes.filter(h => h.fairway && h.par !== 3).length;
                const eligibleFairways = holes.filter(h => h.par !== 3).length;
                const totalPutts = holes.reduce((sum, h) => sum + h.putts, 0);
                const penalties = holes.filter(h => h.penalty && h.penalty !== '').length;
                const totalPenaltyStrokes = holes.reduce((sum, h) => {
                    if (h.penalty === 'wrong') return sum + 2;
                    if (h.penalty && h.penalty !== '') return sum + 1;
                    return sum;
                }, 0);
                
                // Auto-calculate scrambling
                const missedGirs = holes.filter(h => !h.gir);
                const scrambles = missedGirs.filter(h => h.score <= h.par).length;
                
                // Calculate putts per GIR
                const girHoles = holes.filter(h => h.gir);
                const puttsOnGIR = girHoles.reduce((sum, h) => sum + h.putts, 0);
                const puttsPerGIR = girHoles.length > 0 ? (puttsOnGIR / girHoles.length).toFixed(2) : 0;
                
                // Proximity stats for CSV
                const allApproaches = holes.filter(h => h.approachDistance);
                const avgProximity = allApproaches.length > 0 
                    ? (allApproaches.reduce((sum, h) => sum + h.approachDistance, 0) / allApproaches.length).toFixed(1)
                    : 0;
                
                const summary = `\n\nROUND SUMMARY\n` +
                    `Holes Played,${holes.length}\n` +
                    `Total Score,${totalScore}\n` +
                    `Total Par,${totalPar}\n` +
                    `To Par,${totalToPar === 0 ? 'E' : (totalToPar > 0 ? `+${totalToPar}` : `-${Math.abs(totalToPar)}`)}\n` +
                    `GIR,${girsHit}/${holes.length} (${((girsHit/holes.length)*100).toFixed(1)}%)\n` +
                    `Putts per GIR,${puttsPerGIR}\n` +
                    `Avg Proximity,${avgProximity} feet\n` +
                    `Fairways,${fairwaysHit}/${eligibleFairways} (${eligibleFairways > 0 ? ((fairwaysHit/eligibleFairways)*100).toFixed(1) : 0}%)\n` +
                    `Total Putts,${totalPutts} (${(totalPutts/holes.length).toFixed(2)} avg)\n` +
                    `Scrambling,${scrambles}/${missedGirs.length} (${missedGirs.length > 0 ? ((scrambles/missedGirs.length)*100).toFixed(1) : 0}%)\n` +
                    `Penalties,${totalPenaltyStrokes} stroke${totalPenaltyStrokes !== 1 ? 's' : ''} (${penalties} hole${penalties !== 1 ? 's' : ''})\n` +
                    `Date,${new Date().toISOString().split('T')[0]}`;
                
                const blob = new Blob([header + csv + summary], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `karls_gir_round_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            };

            return (
                <div className="min-h-screen bg-gradient-to-b from-black to-black p-2 sm:p-4">
                    <div className="max-w-2xl mx-auto">
                        <div className="bg-[#050a05] rounded-lg p-3 sm:p-4">
                            <div className="grid grid-cols-3 items-center mb-2">
                                <div className="flex justify-start">
                                    {isLoggedIn ? (
                                        <a 
                                            href="dashboard.html"
                                            onClick={(e) => {
                                                // Ensure login state is preserved and add cache-busting
                                                localStorage.setItem('karlsGIR_isLoggedIn', 'true');
                                                // Force a completely fresh load
                                                e.preventDefault();
                                                window.location.replace(`dashboard.html?t=${Date.now()}`);
                                            }}
                                            className="px-3 py-2 border-2 border-[#DDEDD2] text-[#DDEDD2] rounded-lg hover:bg-[#DDEDD2] hover:text-[#0a140a] transition text-sm font-semibold"
                                        >
                                            Dashboard
                                        </a>
                                    ) : (
                                        <a href="login.html" onClick={(e) => {
                                            // Set a flag to show register form on login page
                                            sessionStorage.setItem('showRegister', 'true');
                                            e.currentTarget.href = `login.html?t=${Date.now()}`;
                                        }} className="px-3 py-2 border-2 border-[#DDEDD2] text-[#DDEDD2] rounded-lg hover:bg-[#DDEDD2] hover:text-[#0a140a] transition text-sm font-semibold">
                                            Join
                                        </a>
                                    )}
                                </div>
                                <div className="flex justify-center">
                                    <img src="images/karls_gir.png" alt="Karl's GIR Logo" className="w-16 h-16 rounded-lg" />
                                </div>
                                <div className="flex justify-end">
                                    {isLoggedIn ? (
                                        <button
                                            onClick={async () => {
                                                try {
                                                    // IMPORTANT: Save current round data before logout (preserve unsaved holes)
                                                    if (holes.length > 0) {
                                                        localStorage.setItem('karlsGIR_currentRound', JSON.stringify({
                                                            holes,
                                                            currentHole,
                                                            lastUpdated: new Date().toISOString(),
                                                            savedOnLogout: true // Flag to indicate this was saved on logout
                                                        }));
                                                        console.log('Saved', holes.length, 'unsaved holes before logout');
                                                    }
                                                    
                                                    // Clear login state
                                                    localStorage.setItem('karlsGIR_isLoggedIn', 'false');
                                                    setIsLoggedIn(false);
                                                    
                                                    // Call logout endpoint
                                                    await fetch('auth.php?action=logout', {
                                                        credentials: 'include',
                                                        cache: 'no-store'
                                                    });
                                                    
                                                    // Force a page reload to ensure clean state
                                                    window.location.replace('index.html?t=' + Date.now());
                                                } catch (error) {
                                                    console.error('Logout error:', error);
                                                    // Even if logout fails, preserve round data and clear login state
                                                    if (holes.length > 0) {
                                                        localStorage.setItem('karlsGIR_currentRound', JSON.stringify({
                                                            holes,
                                                            currentHole,
                                                            lastUpdated: new Date().toISOString(),
                                                            savedOnLogout: true
                                                        }));
                                                    }
                                                    localStorage.setItem('karlsGIR_isLoggedIn', 'false');
                                                    setIsLoggedIn(false);
                                                    window.location.replace('index.html?t=' + Date.now());
                                                }
                                            }}
                                            className="px-3 py-2 border-2 border-red-500 text-red-500 rounded-lg hover:bg-red-500 hover:text-white transition text-sm font-semibold"
                                        >
                                            Logout
                                        </button>
                                    ) : (
                                        <a href="login.html" onClick={(e) => {
                                            e.currentTarget.href = `login.html?t=${Date.now()}`;
                                        }} className="px-3 py-2 border-2 border-[#DDEDD2] text-[#DDEDD2] rounded-lg hover:bg-[#DDEDD2] hover:text-[#0a140a] transition text-sm font-semibold">
                                            Login
                                        </a>
                                    )}
                                </div>
                            </div>
                            
                            {/* Prominent Hole Number Display */}
                            <div className="bg-gradient-to-r from-[#228B22] to-[#1e7a1e] rounded-xl p-4 mb-6 shadow-lg border border-[#228B22]">
                                <div className="text-center">
                                    <p className="text-white text-sm font-semibold uppercase tracking-wider mb-1">Current Hole</p>
                                    <p className="text-white text-5xl font-bold">{currentHole}</p>
                                    {currentHole <= 18 && (
                                        <p className="text-white text-xs mt-1">{currentHole <= 9 ? 'Front 9' : 'Back 9'}</p>
                                    )}
                                </div>
                            </div>

                            {currentHole <= 18 ? (
                                <HoleForm onSubmit={addHole} holeNumber={currentHole} onValidationError={() => setShowValidationModal(true)} />
                            ) : (
                                <div className="bg-gradient-to-r from-[#1a2e1a] to-[#2d4a2d] rounded-lg p-6 text-center mb-6 border border-[#2d4a2d]">
                                    <div className="mb-4 flex justify-center">
                                        <Trophy size={64} color="#fbbf24" />
                                    </div>
                                    <h2 className="text-2xl font-bold text-white mb-2">Round Complete!</h2>
                                    <p className="text-white mb-4">You've completed all 18 holes. Great round!</p>
                                    <p className="text-sm text-[#DDEDD2] mb-4">Email your stats, export to CSV, or create a free account to use our built-in dashboard.</p>
                                    <div className="flex flex-col sm:flex-row gap-3 justify-center">
                                        {isLoggedIn && (
                                            <button
                                                onClick={handleSaveRoundClick}
                                                disabled={savingRound || roundSaved}
                                                className="px-6 py-3 bg-[#DDEDD2] text-[#0a140a] rounded-lg hover:bg-green-100 hover:ring-2 hover:ring-green-300 transition font-semibold shadow-md disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
                                            >
                                                {roundSaved ? '✓ Round Saved!' : savingRound ? 'Saving...' : 'Save Round'}
                                            </button>
                                        )}
                                        <button
                                            onClick={() => setShowResetModal(true)}
                                            className="px-6 py-3 bg-[#DDEDD2] text-[#0a140a] rounded-lg hover:bg-green-100 hover:ring-2 hover:ring-green-300 transition font-semibold shadow-md cursor-pointer"
                                        >
                                            Start New Round
                                        </button>
                                    </div>
                                    {!isLoggedIn && (
                                        <p className="text-sm text-[#d1fae5] mt-4">
                                            <a href="login.html" onClick={(e) => { e.currentTarget.href = `login.html?t=${Date.now()}`; }} className="text-blue-400 hover:text-blue-300 font-semibold">Login</a> or <a href="login.html" onClick={(e) => { e.currentTarget.href = `login.html?t=${Date.now()}`; }} className="text-blue-400 hover:text-blue-300 font-semibold">Register</a> to save your rounds and track your progress
                                        </p>
                                    )}
                                </div>
                            )}

                            {/* Create Account Prompt - Shows after first hole if not logged in */}
                            {showCreateAccountPrompt && !isLoggedIn && holes.length > 0 && (
                                <div className="mt-6 bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg p-4 border-2 border-blue-500 shadow-lg">
                                    <div className="flex items-center justify-between gap-4">
                                        <div className="flex-1">
                                            <h3 className="text-white font-bold text-lg mb-1">💾 Save Your Progress!</h3>
                                            <p className="text-blue-100 text-sm">Create a free account to save your rounds and track your progress over time.</p>
                                        </div>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => setShowCreateAccountPrompt(false)}
                                                className="px-3 py-2 bg-blue-800 text-blue-100 rounded hover:bg-blue-900 transition text-sm font-semibold"
                                            >
                                                Later
                                            </button>
                                            <a
                                                href="login.html"
                                                onClick={(e) => {
                                                    // Save current round data to localStorage for restoration after login
                                                    localStorage.setItem('karlsGIR_pendingLogin', JSON.stringify({
                                                        holes,
                                                        currentHole,
                                                        timestamp: new Date().toISOString()
                                                    }));
                                                    e.currentTarget.href = `login.html?t=${Date.now()}`;
                                                }}
                                                className="px-3 py-2 border-2 border-[#DDEDD2] text-[#DDEDD2] rounded hover:bg-[#DDEDD2] hover:text-[#0a140a] transition text-sm font-semibold"
                                            >
                                                Login
                                            </a>
                                            <a
                                                href="login.html"
                                                onClick={(e) => {
                                                    // Save current round data to localStorage with a flag
                                                    localStorage.setItem('karlsGIR_pendingRegistration', JSON.stringify({
                                                        holes,
                                                        currentHole,
                                                        timestamp: new Date().toISOString()
                                                    }));
                                                    e.currentTarget.href = `login.html?t=${Date.now()}`;
                                                }}
                                                className="px-4 py-2 bg-white text-blue-600 rounded hover:bg-blue-50 transition text-sm font-bold shadow-md"
                                            >
                                                Create Account
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {holes.length > 0 && (
                                <div className="mt-8">
                                    <RoundStats holes={holes} />
                                </div>
                            )}

                            <div className="mt-8">
                                <h2 className="text-xl font-bold text-white text-center mb-1">Round Progress</h2>
                                <p className="text-sm text-[#DDEDD2] text-center mb-4 px-4">
                                    At the end of 9 and/or 18 holes, email your stats, export to a CSV, or create a free account and use our built-in dashboard.
                                </p>
                                {holes.length > 0 && (
                                    <div className="flex justify-center gap-2 mb-4 flex-wrap">
                                        {isLoggedIn && holes.length >= 1 && currentHole <= 18 && holes.length > savedHolesCount && (
                                            <button
                                                onClick={handleSaveRoundClick}
                                                disabled={savingRound || roundSaved}
                                                className="px-4 py-2 bg-[#DDEDD2] text-[#0a140a] rounded-lg hover:bg-green-100 hover:ring-2 hover:ring-green-300 transition font-semibold shadow-md disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer whitespace-nowrap"
                                            >
                                                {roundSaved ? '✓ Saved!' : savingRound ? 'Saving...' : 'Save Round'}
                                            </button>
                                        )}
                                        <button
                                            onClick={exportData}
                                            className="flex items-center gap-2 px-3 py-2 border-2 border-[#DDEDD2] text-[#DDEDD2] rounded-lg hover:bg-[#DDEDD2] hover:text-[#0a140a] transition cursor-pointer"
                                        >
                                            <Download size={18} />
                                            Export CSV
                                        </button>
                                        <button
                                            onClick={() => setShowResetModal(true)}
                                            className="flex items-center gap-2 px-3 py-2 border-2 border-red-500 text-red-500 rounded-lg hover:bg-red-500 hover:text-white transition cursor-pointer"
                                        >
                                            <RotateCcw size={18} />
                                            Reset
                                        </button>
                                    </div>
                                )}

                                {holes.length === 0 ? (
                                    <p className="text-[#DDEDD2] text-center py-8">No holes recorded yet</p>
                                ) : (
                                    <div className="space-y-2 max-h-96 overflow-y-auto">
                                        {holes.map((hole, idx) => {
                                            const toPar = hole.score - hole.par;
                                            const scoreColor = toPar < 0 ? 'text-blue-400' : toPar === 0 ? 'text-green-400' : toPar === 1 ? 'text-yellow-400' : 'text-red-400';
                                            
                                            return (
                                                <div
                                                    key={idx}
                                                    className="bg-[#1a2e1a] p-3 rounded-lg border-2 border-[#2d4a2d] shadow-sm"
                                                >
                                                    <div className="flex items-center justify-between mb-2">
                                                        <div className="flex items-center gap-3">
                                                            <span className="font-bold text-xl text-white">#{hole.holeNumber}</span>
                                                            <span className="text-sm text-[#d1fae5]">Par {hole.par}</span>
                                                            <span className={`font-bold text-lg ${scoreColor}`}>
                                                                {hole.score} ({toPar === 0 ? 'E' : toPar > 0 ? `+${toPar}` : `-${Math.abs(toPar)}`})
                                                            </span>
                                                        </div>
                                                        <button
                                                            onClick={() => deleteHole(idx)}
                                                            className="px-2 py-1 bg-red-900 text-red-300 rounded text-xs hover:bg-red-800 transition font-semibold border border-red-700"
                                                        >
                                                            Delete
                                                        </button>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2 text-xs">
                                                        {hole.gir ? (
                                                            <span className="bg-green-900 text-green-300 px-2 py-1 rounded font-semibold border border-green-700">✓ GIR</span>
                                                        ) : (
                                                            <span className="bg-red-900 text-red-300 px-2 py-1 rounded font-semibold border border-red-700">✗ GIR</span>
                                                        )}
                                                        {hole.par !== 3 && hole.fairway !== null && (
                                                            hole.fairway ? (
                                                                <span className="bg-green-900 text-green-300 px-2 py-1 rounded font-semibold border border-green-700">
                                                                    ✓ FIR
                                                                </span>
                                                            ) : (
                                                                <span className="bg-red-900 text-red-300 px-2 py-1 rounded font-semibold border border-red-700">✗ FIR</span>
                                                            )
                                                        )}
                                                        <span className="bg-blue-900 text-blue-300 px-2 py-1 rounded font-semibold border border-blue-700">
                                                            {hole.putts} putt{hole.putts !== 1 ? 's' : ''}
                                                        </span>
                                                        {hole.approachDistance && (
                                                            <span className="bg-cyan-900 text-cyan-300 px-2 py-1 rounded font-semibold border border-cyan-700">
                                                                {hole.approachDistance}ft proximity
                                                            </span>
                                                        )}
                                                        {hole.penalty && hole.penalty !== '' && (
                                                            <span className="bg-red-900 text-red-300 px-2 py-1 rounded font-semibold flex items-center gap-1 border border-red-700">
                                                                <Warning size={14} /> {hole.penalty === 'wrong' ? 'Wrong Ball (+2)' : 
                                                                   hole.penalty === 'ob' ? 'OB (+1)' :
                                                                   hole.penalty === 'water' ? 'Water (+1)' :
                                                                   hole.penalty === 'lost' ? 'Lost (+1)' :
                                                                   hole.penalty === 'other' ? 'Other (+1)' :
                                                                   'Penalty (+1)'}
                                                            </span>
                                                        )}
                                                        {!hole.gir && hole.score <= hole.par && (
                                                            <span className="bg-purple-900 text-purple-300 px-2 py-1 rounded font-semibold flex items-center gap-1 border border-purple-700">
                                                                <Star size={14} /> Scrambled
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Merge Round Modal - Simple choice: Add to existing or create new */}
                    {showMergeRoundModal && incompleteRounds.length > 0 && (
                        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                            <div className="bg-[#050a05] rounded-lg shadow-xl max-w-md w-full p-6 border border-[#1a2e1a]">
                                <h3 className="text-xl font-bold text-white mb-3">Save Round</h3>
                                <p className="text-white mb-4">
                                    You have an incomplete round for <strong>{incompleteRounds[0].courseName}</strong> with {incompleteRounds[0].holeCount} holes.
                                </p>
                                
                                <div className="flex gap-3 justify-end">
                                    <button
                                        onClick={() => {
                                            // Create new round - clear merge flag and proceed
                                            setShowMergeRoundModal(false);
                                            setMergeIntoRoundId(null);
                                            saveRound();
                                        }}
                                        className="px-4 py-2 bg-[#2d4a2d] text-white rounded-lg hover:bg-slate-500 transition font-semibold cursor-pointer"
                                    >
                                        Create New Round
                                    </button>
                                    <button
                                        onClick={async () => {
                                            // Add to existing round - set merge ID and course name
                                            const mergeId = incompleteRounds[0].index;
                                            const existingCourseName = incompleteRounds[0].courseName;
                                            console.log('Adding to existing round - mergeId:', mergeId, 'courseName:', existingCourseName);
                                            
                                            // Set state
                                            setMergeIntoRoundId(mergeId);
                                            setCourseName(existingCourseName);
                                            setShowMergeRoundModal(false);
                                            
                                            // Use a longer delay to ensure React state updates complete
                                            await new Promise(resolve => setTimeout(resolve, 200));
                                            
                                            // Call saveRound with explicit merge ID to ensure it's used
                                            const currentHoles = holes; // Capture current holes
                                            const currentCourseName = existingCourseName; // Use the existing course name
                                            
                                            // Call saveRound directly with merge ID
                                            if (currentHoles.length === 0) return;
                                            
                                            setSavingRound(true);
                                            setRoundSaved(false);
                                            
                                            try {
                                                // Calculate stats
                                                const totalPar = currentHoles.reduce((sum, h) => sum + h.par, 0);
                                                const totalScore = currentHoles.reduce((sum, h) => sum + h.score, 0);
                                                const totalToPar = totalScore - totalPar;
                                                const girsHit = currentHoles.filter(h => h.gir).length;
                                                const fairwaysHit = currentHoles.filter(h => h.fairway && h.par !== 3).length;
                                                const eligibleFairways = currentHoles.filter(h => h.par !== 3).length;
                                                const totalPutts = currentHoles.reduce((sum, h) => sum + h.putts, 0);
                                                const missedGirs = currentHoles.filter(h => !h.gir);
                                                const scrambles = missedGirs.filter(h => h.score <= h.par).length;
                                                const penalties = currentHoles.filter(h => h.penalty && h.penalty !== '').length;
                                                const totalPenaltyStrokes = currentHoles.reduce((sum, h) => {
                                                    if (h.penalty === 'wrong') return sum + 2;
                                                    if (h.penalty && h.penalty !== '') return sum + 1;
                                                    return sum;
                                                }, 0);
                                                const girHoles = currentHoles.filter(h => h.gir);
                                                const puttsOnGIR = girHoles.reduce((sum, h) => sum + h.putts, 0);
                                                const puttsPerGIR = girHoles.length > 0 ? (puttsOnGIR / girHoles.length).toFixed(2) : 0;
                                                const allApproaches = currentHoles.filter(h => h.approachDistance);
                                                const avgProximity = allApproaches.length > 0 
                                                    ? (allApproaches.reduce((sum, h) => sum + h.approachDistance, 0) / allApproaches.length).toFixed(1)
                                                    : 0;
                                                
                                                console.log('Saving with merge ID:', mergeId, 'courseName:', currentCourseName);
                                                
                                                const response = await fetch('save-round.php', {
                                                    method: 'POST',
                                                    credentials: 'include',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify({
                                                        holes: currentHoles,
                                                        courseName: currentCourseName,
                                                        mergeIntoRoundId: mergeId,
                                                        stats: {
                                                            totalHoles: currentHoles.length,
                                                            totalScore,
                                                            totalPar,
                                                            toPar: totalToPar,
                                                            girsHit,
                                                            totalGirs: currentHoles.length,
                                                            avgProximity,
                                                            fairwaysHit,
                                                            eligibleFairways,
                                                            totalPutts,
                                                            avgPutts: (totalPutts / currentHoles.length).toFixed(2),
                                                            puttsPerGIR,
                                                            scrambles,
                                                            missedGirs: missedGirs.length,
                                                            penalties,
                                                            totalPenaltyStrokes
                                                        }
                                                    })
                                                });
                                                
                                                const result = await response.json();
                                                console.log('Save result:', result);
                                                
                                                if (result.success) {
                                                    setRoundSaved(true);
                                                    setSavedHolesCount(result.merged ? result.totalHoles : currentHoles.length);
                                                    setCourseName('');
                                                    setMergeIntoRoundId(null);
                                                    
                                                    const isComplete = (currentHoles.length === 9 || currentHoles.length === 18);
                                                    if (isComplete) {
                                                        fetch('sync-current-round.php?action=delete', {
                                                            method: 'DELETE',
                                                            credentials: 'include'
                                                        }).catch(err => console.log('Error clearing server current round:', err));
                                                    }
                                                    
                                                    setTimeout(() => {
                                                        setRoundSaved(false);
                                                    }, 3000);
                                                } else {
                                                    alert('Error saving round: ' + result.message);
                                                }
                                            } catch (error) {
                                                alert('Error saving round. Please try again.');
                                                console.error('Save round error:', error);
                                            } finally {
                                                setSavingRound(false);
                                            }
                                        }}
                                        className="px-4 py-2 bg-[#DDEDD2] text-[#0a140a] rounded-lg hover:bg-green-100 hover:ring-2 hover:ring-green-300 transition font-semibold shadow-md cursor-pointer"
                                    >
                                        Add to Existing Round
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Course Name Modal */}
                    {showCourseNameModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                            <div className="bg-[#050a05] rounded-lg shadow-xl max-w-md w-full p-6 border border-[#1a2e1a]">
                                <h3 className="text-xl font-bold text-white mb-3">Save Round</h3>
                                <p className="text-white mb-4">Select a course name or enter a new one:</p>
                                <div className="mb-6">
                                    <label className="block text-sm font-semibold text-white mb-2">
                                        Course Name <span className="text-red-400">*</span>
                                    </label>
                                    
                                    {/* Dropdown of existing course names */}
                                    {existingCourseNames.length > 0 && (
                                        <div className="mb-3">
                                            <label className="block text-xs text-[#DDEDD2] mb-1">Select from saved courses:</label>
                                            <select
                                                value={courseName}
                                                onChange={async (e) => {
                                                    if (e.target.value) {
                                                        const selectedCourse = e.target.value;
                                                        setCourseName(selectedCourse);
                                                        console.log('Course name selected from dropdown:', selectedCourse);
                                                        
                                                        // When a course is selected, immediately check if there's an incomplete round
                                                        // This gives immediate feedback
                                                        const incomplete = await checkIncompleteRounds(selectedCourse);
                                                        const validIncomplete = incomplete.filter(r => r.holeCount < 18);
                                                        if (validIncomplete.length > 0) {
                                                            console.log('Found incomplete round for selected course:', validIncomplete[0]);
                                                        }
                                                    }
                                                }}
                                                className="w-full px-4 py-2 bg-[#DDEDD2] text-[#0a140a] border-2 border-[#DDEDD2] rounded-lg focus:outline-none focus:border-green-500"
                                            >
                                                <option value="">-- Select a course --</option>
                                                {existingCourseNames.map((name, idx) => (
                                                    <option key={idx} value={name}>{name}</option>
                                                ))}
                                            </select>
                                        </div>
                                    )}
                                    
                                    <div className="mb-2">
                                        <label className="block text-xs text-[#DDEDD2] mb-1">
                                            {existingCourseNames.length > 0 ? 'Or enter a new course name:' : 'Enter course name:'}
                                        </label>
                                        <input
                                            type="text"
                                            value={courseName}
                                            onChange={(e) => setCourseName(e.target.value)}
                                            placeholder="e.g., Pebble Beach, Augusta National"
                                            className="w-full px-4 py-2 bg-[#DDEDD2] text-[#0a140a] border-2 border-[#DDEDD2] rounded-lg focus:outline-none focus:border-green-500 placeholder-[#3d5a3d]"
                                            onKeyPress={(e) => {
                                                if (e.key === 'Enter' && courseName.trim()) {
                                                    const enteredCourseName = courseName.trim();
                                                    const holeCount = holes.length;
                                                    const isCompleteRound = (holeCount === 9 || holeCount === 18);
                                                    
                                                    if (!isCompleteRound && enteredCourseName !== 'Unnamed Course') {
                                                        checkIncompleteRounds(enteredCourseName).then(incomplete => {
                                                            if (incomplete.length > 0) {
                                                                setIncompleteRounds(incomplete);
                                                                setCourseName(enteredCourseName);
                                                                setShowCourseNameModal(false);
                                                                setShowMergeRoundModal(true);
                                                            } else {
                                                                saveRound();
                                                            }
                                                        });
                                                    } else {
                                                        saveRound();
                                                    }
                                                }
                                            }}
                                            autoFocus
                                        />
                                    </div>
                                    <p className="text-xs text-red-400 mt-2">Course name is required</p>
                                </div>
                                <div className="flex gap-3 justify-end">
                                    <button
                                        onClick={() => {
                                            setShowCourseNameModal(false);
                                            setCourseName('');
                                        }}
                                        className="px-4 py-2 bg-[#2d4a2d] text-white rounded hover:bg-slate-500 transition font-semibold"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={async () => {
                                            // Require course name
                                            const enteredCourseName = courseName.trim();
                                            if (!enteredCourseName) {
                                                alert('Please enter or select a course name');
                                                return;
                                            }
                                            
                                            // Check if there's an existing incomplete round (< 18 holes) with this course name
                                            const incomplete = await checkIncompleteRounds(enteredCourseName);
                                            console.log('Checking for incomplete rounds with course:', enteredCourseName, 'Found:', incomplete);
                                            
                                            // Filter to only rounds with < 18 holes (should already be filtered, but double-check)
                                            const validIncomplete = incomplete.filter(r => r.holeCount < 18);
                                            
                                            if (validIncomplete.length > 0) {
                                                // Found matching incomplete round - show simple choice modal
                                                setIncompleteRounds(validIncomplete);
                                                setCourseName(enteredCourseName);
                                                setShowCourseNameModal(false);
                                                setShowMergeRoundModal(true);
                                                return;
                                            }
                                            
                                            // No matching incomplete round - create new round
                                            setMergeIntoRoundId(null);
                                            saveRound();
                                        }}
                                        disabled={savingRound || !courseName.trim()}
                                        className="px-6 py-2 bg-[#DDEDD2] text-[#0a140a] rounded-lg hover:bg-green-100 hover:ring-2 hover:ring-green-300 transition font-semibold shadow-md disabled:bg-[#2d4a2d] disabled:text-gray-400 disabled:cursor-not-allowed cursor-pointer"
                                    >
                                        {savingRound ? 'Saving...' : 'Save Round'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Email Results Modal */}
                    {showEmailModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                            <div className="bg-[#050a05] rounded-lg shadow-xl max-w-md w-full p-6 border border-[#1a2e1a]">
                                {!emailSent ? (
                                    <>
                                        <h3 className="text-xl font-bold text-white mb-3 flex items-center justify-center gap-2">
                                            {emailModalType === '9hole' ? (
                                                <>Front 9 Complete! <Party /></>
                                            ) : (
                                                <>Round Complete! <Trophy size={24} color="#fbbf24" /></>
                                            )}
                                        </h3>
                                        <p className="text-white mb-4">
                                            {emailModalType === '9hole' 
                                                ? 'Great job finishing the front 9! Would you like to email your results?'
                                                : 'Congratulations on completing your round! Would you like to email your results?'}
                                        </p>
                                        <div className="mb-6">
                                            <label className="block text-sm font-semibold text-white mb-2">
                                                Email Address
                                            </label>
                                            <input
                                                type="email"
                                                value={userEmail}
                                                onChange={(e) => setUserEmail(e.target.value)}
                                                placeholder="your@email.com"
                                                className="w-full px-4 py-2 bg-[#DDEDD2] text-[#0a140a] border-2 border-[#DDEDD2] rounded-lg focus:outline-none focus:border-green-500 placeholder-[#3d5a3d]"
                                                disabled={emailSending}
                                            />
                                        </div>
                                        <div className="flex gap-3 justify-end">
                                            <button
                                                onClick={skipEmail}
                                                className="px-4 py-2 bg-[#2d4a2d] text-white rounded hover:bg-slate-500 transition font-semibold"
                                                disabled={emailSending}
                                            >
                                                Skip
                                            </button>
                                            <button
                                                onClick={sendEmail}
                                                className="px-6 py-2 bg-[#DDEDD2] text-[#0a140a] rounded-lg hover:bg-green-100 hover:ring-2 hover:ring-green-300 transition font-semibold shadow-md disabled:bg-[#2d4a2d] disabled:cursor-not-allowed cursor-pointer"
                                                disabled={emailSending}
                                            >
                                                {emailSending ? 'Sending...' : 'Send Email'}
                                            </button>
                                        </div>
                                    </>
                                ) : (
                                    <div className="text-center py-4">
                                        <div className="mb-4 flex justify-center">
                                            <CheckCircle size={64} color="#4ade80" />
                                        </div>
                                        <h3 className="text-xl font-bold text-green-400 mb-2">Email Sent!</h3>
                                        <p className="text-white">Check your inbox for your round results.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Validation Modal */}
                    {showValidationModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                            <div className="bg-[#050a05] rounded-lg shadow-xl max-w-md w-full p-6 border border-[#1a2e1a]">
                                <h3 className="text-xl font-bold text-white mb-3">Missing Information</h3>
                                <p className="text-white mb-6">{validationMessage}</p>
                                <div className="flex justify-end">
                                    <button
                                        onClick={() => {
                                            setShowValidationModal(false);
                                            setValidationMessage('Please fill in all required fields before submitting.');
                                        }}
                                        className="px-6 py-2 bg-[#DDEDD2] text-[#0a140a] rounded-lg hover:bg-green-100 hover:ring-2 hover:ring-green-300 transition font-semibold shadow-md cursor-pointer"
                                    >
                                        OK
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Reset Confirmation Modal */}
                    {showResetModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                            <div className="bg-[#050a05] rounded-lg shadow-xl max-w-md w-full p-6 border border-[#1a2e1a]">
                                <h3 className="text-xl font-bold text-white mb-3">Reset All Data?</h3>
                                <p className="text-white mb-6">Are you sure you want to reset all data? This will clear all recorded holes and cannot be undone.</p>
                                <div className="flex gap-3 justify-end">
                                    <button
                                        onClick={() => setShowResetModal(false)}
                                        className="px-4 py-2 bg-[#2d4a2d] text-white rounded hover:bg-slate-500 transition font-semibold"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={confirmReset}
                                        className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition font-semibold"
                                    >
                                        Reset All
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Round Stats Component
        function RoundStats({ holes }) {
            const totalHoles = holes.length;
            
            // Calculate all stats
            const totalPar = holes.reduce((sum, h) => sum + h.par, 0);
            const totalScore = holes.reduce((sum, h) => sum + h.score, 0);
            const toPar = totalScore - totalPar;
            
            const girsHit = holes.filter(h => h.gir).length;
            const girPct = ((girsHit / totalHoles) * 100).toFixed(1);
            
            // Proximity stats
            const allApproaches = holes.filter(h => h.approachDistance);
            const avgProximity = allApproaches.length > 0 
                ? (allApproaches.reduce((sum, h) => sum + h.approachDistance, 0) / allApproaches.length).toFixed(1)
                : 0;
            
            const girApproaches = holes.filter(h => h.gir && h.approachDistance);
            const avgProximityGIR = girApproaches.length > 0
                ? (girApproaches.reduce((sum, h) => sum + h.approachDistance, 0) / girApproaches.length).toFixed(1)
                : 0;
                
            const missedGirApproaches = holes.filter(h => !h.gir && h.approachDistance);
            const avgProximityMissed = missedGirApproaches.length > 0
                ? (missedGirApproaches.reduce((sum, h) => sum + h.approachDistance, 0) / missedGirApproaches.length).toFixed(1)
                : 0;
            
            const eligibleFairways = holes.filter(h => h.par !== 3);
            const fairwaysHit = eligibleFairways.filter(h => h.fairway).length;
            const fairwayPct = eligibleFairways.length > 0 ? ((fairwaysHit / eligibleFairways.length) * 100).toFixed(1) : 0;
            
            const totalPutts = holes.reduce((sum, h) => sum + h.putts, 0);
            const avgPutts = (totalPutts / totalHoles).toFixed(2);
            
            // Auto-calculate scrambling: par or better when GIR missed
            const missedGirs = holes.filter(h => !h.gir);
            const scrambles = missedGirs.filter(h => h.score <= h.par).length;
            const scramblingPct = missedGirs.length > 0 ? ((scrambles / missedGirs.length) * 100).toFixed(1) : 0;
            
            // Calculate putts per GIR
            const girHoles = holes.filter(h => h.gir);
            const puttsOnGIR = girHoles.reduce((sum, h) => sum + h.putts, 0);
            const puttsPerGIR = girHoles.length > 0 ? (puttsOnGIR / girHoles.length).toFixed(2) : '0.00';
            
            const penalties = holes.filter(h => h.penalty && h.penalty !== '').length;
            const totalPenaltyStrokes = holes.reduce((sum, h) => {
                if (h.penalty === 'wrong') return sum + 2;
                if (h.penalty && h.penalty !== '') return sum + 1;
                return sum;
            }, 0);
            const threePutts = holes.filter(h => h.putts >= 3).length;
            
            // Front 9 / Back 9 split (if applicable)
            const front9 = holes.filter(h => h.holeNumber <= 9);
            const back9 = holes.filter(h => h.holeNumber > 9);
            const front9Score = front9.reduce((sum, h) => sum + h.score, 0);
            const front9Par = front9.reduce((sum, h) => sum + h.par, 0);
            const back9Score = back9.reduce((sum, h) => sum + h.score, 0);
            const back9Par = back9.reduce((sum, h) => sum + h.par, 0);
            
            // Stroke impact analysis
            const expectedPutts = totalHoles * 2; // Expected 2 putts per hole
            const puttingImpact = totalPutts - expectedPutts;
            
            const expectedGIRScore = girsHit * 2; // Expected 2 putts when hit GIR
            const missedGIRScore = missedGirs.length * 3; // Expected 3 strokes to finish when miss GIR
            const scramblingImpact = (missedGirs.length - scrambles); // Holes where didn't scramble
            
            const penaltyImpact = penalties; // Each penalty = 1 stroke
            
            // Determine main issue and recommendation
            let mainIssue = '';
            let recommendation = '';
            let strokesLost = 0;
            
            if (threePutts >= 2) {
                strokesLost = threePutts;
                mainIssue = `Three-putts cost you ${strokesLost} strokes`;
                recommendation = `You 3-putted ${threePutts} times. Practice lag putting from 30-40 feet. Focus on getting within tap-in range.`;
            } else if (puttingImpact > 3) {
                strokesLost = Math.round(puttingImpact);
                mainIssue = `Putting cost you ~${strokesLost} strokes`;
                recommendation = `${totalPutts} putts in ${totalHoles} holes (${avgPutts} avg). Work on speed control and distance from 10-20 feet.`;
            } else if (scramblingPct < 30 && missedGirs.length > 0) {
                strokesLost = Math.round(scramblingImpact);
                mainIssue = `Poor scrambling cost you ~${strokesLost} strokes`;
                recommendation = `Only ${scrambles}/${missedGirs.length} up & downs (${scramblingPct}%). Practice chipping and short game to save par when you miss greens.`;
            } else if (girPct < 40) {
                strokesLost = Math.round(missedGirs.length * 0.5);
                mainIssue = `Missed GIRs cost you ~${strokesLost} strokes`;
                recommendation = `Only ${girsHit}/${totalHoles} GIRs (${girPct}%). Focus on approach shots and club selection.`;
            } else if (penalties > 0) {
                strokesLost = penalties;
                mainIssue = `${penalties} penalty stroke${penalties > 1 ? 's' : ''} hurt your score`;
                recommendation = `Avoid big numbers. Play smart golf and keep the ball in play.`;
            } else if (fairwayPct < 50 && eligibleFairways.length > 0) {
                strokesLost = Math.round((eligibleFairways.length - fairwaysHit) * 0.3);
                mainIssue = `Missed fairways cost you ~${strokesLost} strokes`;
                recommendation = `Only ${fairwaysHit}/${eligibleFairways.length} fairways (${fairwayPct}%). Work on driving accuracy.`;
            } else {
                mainIssue = 'Solid round overall!';
                recommendation = 'Keep working on consistency. Small improvements in each area will add up.';
            }
            
            // Color coding function for dark theme
            const getColor = (pct, reverse = false) => {
                if (reverse) {
                    if (pct >= 60) return 'text-green-400 font-bold';
                    if (pct >= 40) return 'text-yellow-400 font-bold';
                    return 'text-red-400 font-bold';
                } else {
                    if (pct <= 33) return 'text-red-400 font-bold';
                    if (pct <= 55) return 'text-yellow-400 font-bold';
                    return 'text-green-400 font-bold';
                }
            };

            return (
                <div className="space-y-4 mb-6">
                    {/* Score Summary */}
                    <div className="bg-gradient-to-r from-[#1a2e1a] to-[#2d4a2d] rounded-lg p-4 border-2 border-[#3d5a3d]">
                        <h2 className="text-xl font-bold mb-2 text-center text-white">Total Strokes</h2>
                        <div className="text-center">
                            <div className="text-5xl font-bold text-white">{totalScore}</div>
                            <div className="text-xl mt-1 text-white">
                                ({toPar === 0 ? 'Even' : toPar > 0 ? `+${toPar}` : toPar})
                            </div>
                            <div className="text-sm mt-2 text-[#d1fae5]">{totalHoles} holes</div>
                        </div>
                    </div>
                    
                    {/* 6 Essential College Coach Metrics */}
                    <div className="bg-gradient-to-r from-[#1a2e1a] to-[#2d4a2d] rounded-lg p-4 border-2 border-[#3d5a3d]">
                        <h3 className="text-lg font-bold text-white mb-4 text-center flex items-center justify-center gap-2">
                            <Chart /> College Coach Metrics
                        </h3>
                        <div className="grid grid-cols-2 gap-4">
                            {/* GIR */}
                            <div className="bg-[#050a05] rounded-lg p-4 shadow border border-[#2d4a2d] text-center">
                                <div className="text-xs text-[#d1fae5] mb-1 font-semibold">GIR</div>
                                <div className={`text-3xl font-bold ${getColor(girPct, true)}`}>{girPct}%</div>
                                <div className="text-sm text-[#DDEDD2] mt-1">{girsHit}/{totalHoles}</div>
                            </div>
                            
                            {/* Fairways Hit */}
                            <div className="bg-[#050a05] rounded-lg p-4 shadow border border-[#2d4a2d] text-center">
                                <div className="text-xs text-[#d1fae5] mb-1 font-semibold">Fairways</div>
                                <div className={`text-3xl font-bold ${getColor(fairwayPct, true)}`}>
                                    {fairwayPct}%
                                </div>
                                <div className="text-sm text-[#DDEDD2] mt-1">{fairwaysHit}/{eligibleFairways.length}</div>
                            </div>
                            
                            {/* Putts per GIR */}
                            <div className="bg-[#050a05] rounded-lg p-4 shadow border border-[#2d4a2d] text-center">
                                <div className="text-xs text-[#d1fae5] mb-1 font-semibold">Putts per GIR</div>
                                <div className={`text-3xl font-bold ${
                                    parseFloat(puttsPerGIR) <= 1.8 ? 'text-green-400' : 
                                    parseFloat(puttsPerGIR) <= 2.0 ? 'text-yellow-400' : 'text-red-400'
                                }`}>
                                    {puttsPerGIR}
                                </div>
                                <div className="text-sm text-[#DDEDD2] mt-1">{puttsOnGIR} putts on {girHoles.length} GIRs</div>
                            </div>
                            
                            {/* Scrambling */}
                            <div className="bg-[#050a05] rounded-lg p-4 shadow border border-[#2d4a2d] text-center">
                                <div className="text-xs text-[#d1fae5] mb-1 font-semibold">Scrambling</div>
                                <div className={`text-3xl font-bold ${getColor(scramblingPct, true)}`}>
                                    {scramblingPct}%
                                </div>
                                <div className="text-sm text-[#DDEDD2] mt-1">{scrambles}/{missedGirs.length}</div>
                            </div>
                            
                            {/* Penalties */}
                            <div className="bg-[#050a05] rounded-lg p-4 shadow border border-[#2d4a2d] text-center col-span-2">
                                <div className="text-xs text-[#d1fae5] mb-1 font-semibold">Penalties</div>
                                <div className={`text-3xl font-bold ${totalPenaltyStrokes > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                    {totalPenaltyStrokes}
                                </div>
                                <div className="text-sm text-[#DDEDD2] mt-1">{penalties} hole{penalties !== 1 ? 's' : ''} ({totalPenaltyStrokes} stroke{totalPenaltyStrokes !== 1 ? 's' : ''})</div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Additional Stats */}
                    <div className="bg-[#1a2e1a] rounded-lg p-4 shadow border border-[#2d4a2d]">
                        <div className="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span className="text-[#d1fae5]">Total Putts:</span>
                                <span className="ml-2 font-bold text-blue-400">{totalPutts}</span>
                                <span className="text-[#DDEDD2] text-xs ml-1">({avgPutts} avg)</span>
                            </div>
                            <div>
                                <span className="text-[#d1fae5]">3-Putts:</span>
                                <span className={`ml-2 font-bold ${threePutts > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                    {threePutts}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    {/* Proximity Stats */}
                    <div className="bg-gradient-to-r from-[#1a2e1a] to-[#2d4a2d] rounded-lg p-4 shadow border-2 border-[#3d5a3d]">
                        <h3 className="font-bold text-white mb-3 text-center flex items-center justify-center gap-2">
                            <LocationPin /> Approach Proximity
                        </h3>
                        <div className="grid grid-cols-3 gap-3 mb-3">
                            <div className="text-center">
                                <div className="text-xs text-[#d1fae5] mb-1">Overall Avg</div>
                                <div className={`text-2xl font-bold ${
                                    avgProximity <= 15 ? 'text-green-400' : 
                                    avgProximity <= 30 ? 'text-yellow-400' : 'text-red-400'
                                }`}>
                                    {avgProximity}'
                                </div>
                                <div className="text-xs text-[#DDEDD2]">All approaches</div>
                            </div>
                            <div className="text-center">
                                <div className="text-xs text-[#d1fae5] mb-1">On GIR</div>
                                <div className={`text-2xl font-bold ${
                                    avgProximityGIR <= 15 ? 'text-green-400' : 
                                    avgProximityGIR <= 30 ? 'text-yellow-400' : 'text-red-400'
                                }`}>
                                    {avgProximityGIR || '-'}'
                                </div>
                                <div className="text-xs text-[#DDEDD2]">{girApproaches.length} shots</div>
                            </div>
                            <div className="text-center">
                                <div className="text-xs text-[#d1fae5] mb-1">Missed GIR</div>
                                <div className={`text-2xl font-bold ${
                                    avgProximityMissed <= 15 ? 'text-green-400' : 
                                    avgProximityMissed <= 30 ? 'text-yellow-400' : 'text-red-400'
                                }`}>
                                    {avgProximityMissed || '-'}'
                                </div>
                                <div className="text-xs text-[#DDEDD2]">{missedGirApproaches.length} shots</div>
                            </div>
                        </div>
                        <div className="text-xs text-center text-[#d1fae5] bg-[#050a05] bg-opacity-70 rounded p-2 border border-[#2d4a2d]">
                            <strong>Goal:</strong> &lt;15ft = Excellent • 15-30ft = Good • &gt;30ft = Needs Work
                        </div>
                    </div>
                    
                    {/* Front/Back 9 Split */}
                    {back9.length > 0 && (
                        <div className="bg-[#1a2e1a] rounded-lg p-4 shadow border border-[#2d4a2d]">
                            <h3 className="font-bold text-white mb-2 text-sm">Front 9 / Back 9</h3>
                            <div className="grid grid-cols-2 gap-3 text-sm">
                                <div>
                                    <span className="text-[#d1fae5]">Front 9:</span>
                                    <span className="ml-2 font-bold text-white">{front9Score}</span>
                                    <span className="text-[#DDEDD2] ml-1">
                                        ({front9Score - front9Par === 0 ? 'E' : front9Score - front9Par > 0 ? `+${front9Score - front9Par}` : `-${Math.abs(front9Score - front9Par)}`})
                                    </span>
                                </div>
                                <div>
                                    <span className="text-[#d1fae5]">Back 9:</span>
                                    <span className="ml-2 font-bold text-white">{back9Score}</span>
                                    <span className="text-[#DDEDD2] ml-1">
                                        ({back9Score - back9Par === 0 ? 'E' : back9Score - back9Par > 0 ? `+${back9Score - back9Par}` : `-${Math.abs(back9Score - back9Par)}`})
                                    </span>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Analysis & Recommendation */}
                    <div className="bg-gradient-to-r from-[#1a2e1a] to-[#2d4a2d] rounded-lg p-4 border border-[#3d5a3d]">
                        <div className="flex items-start gap-2">
                            <Lightbulb size={24} />
                            <div>
                                <p className="font-bold text-orange-300 mb-1">{mainIssue}</p>
                                <p className="text-sm text-white">{recommendation}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Hole Form Component
        function HoleForm({ onSubmit, holeNumber, onValidationError }) {
            const [par, setPar] = useState(null);
            const [gir, setGir] = useState(null);
            const [putts, setPutts] = useState('');
            const [fairway, setFairway] = useState(null);
            const [approachDistance, setApproachDistance] = useState('');
            const [shotsToGreen, setShotsToGreen] = useState('');
            const [penalty, setPenalty] = useState('');

            const handleSubmit = () => {
                // Validate required fields
                if (par === null || gir === null || !putts || putts === '' || isNaN(parseInt(putts)) || !approachDistance || approachDistance === '' || isNaN(parseInt(approachDistance))) {
                    onValidationError();
                    return;
                }
                
                // Validate: GIR cannot be Yes on par 3 with penalty
                if (par === 3 && penalty && penalty !== '' && gir === 'y') {
                    onValidationError();
                    return;
                }
                
                // Validate fairway for par 4/5
                if (par !== 3 && fairway === null) {
                    onValidationError();
                    return;
                }

                // Validate shots to green if GIR = No
                if (gir === 'n' && (!shotsToGreen || shotsToGreen === '' || isNaN(parseInt(shotsToGreen)))) {
                    onValidationError();
                    return;
                }

                // Calculate penalty strokes
                const penaltyStrokes = penalty === 'wrong' ? 2 : penalty && penalty !== '' ? 1 : 0;

                // Auto-calculate score
                let calculatedScore;
                if (gir === 'y') {
                    // If GIR: Score = Par + (Putts - 2) + Penalties
                    calculatedScore = par + (parseInt(putts) - 2) + penaltyStrokes;
                } else {
                    // If no GIR: Score = Shots to green + Putts + Penalties
                    calculatedScore = parseInt(shotsToGreen) + parseInt(putts) + penaltyStrokes;
                }

                onSubmit({
                    par: parseInt(par),
                    score: calculatedScore,
                    gir: gir === 'y',
                    putts: parseInt(putts),
                    fairway: par === 3 ? null : fairway === 'y',
                    approachDistance: parseInt(approachDistance),
                    penalty: penalty || null
                });

                // Reset form
                setPar(null);
                setGir(null);
                setPutts('');
                setFairway(null);
                setApproachDistance('');
                setShotsToGreen('');
                setPenalty('');
            };

            return (
                <div className="space-y-5">
                    {/* 1. Par Selection - Known before teeing off */}
                    <div>
                        <label className="block text-base font-bold text-white mb-3">Par</label>
                        <div className="flex gap-3">
                            {[3, 4, 5].map(p => (
                                <button
                                    key={p}
                                    onClick={() => setPar(p)}
                                    className={`flex-1 py-4 text-lg rounded-lg font-bold transition cursor-pointer ${
                                        par === p
                                            ? 'bg-green-600 text-white shadow-lg ring-2 ring-green-400'
                                            : 'bg-[#DDEDD2] text-[#0a140a] hover:bg-green-100 hover:ring-2 hover:ring-green-300'
                                    }`}
                                >
                                    Par {p}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* 2. Penalty - Most common on tee shot or approach shot */}
                    <div>
                        <label className="block text-base font-bold text-white mb-2">Penalty?</label>
                        <select
                            value={penalty}
                            onChange={(e) => {
                                setPenalty(e.target.value);
                                // If penalty is selected on par 3, GIR cannot be Yes
                                if (par === 3 && e.target.value && e.target.value !== '') {
                                    if (gir === 'y') {
                                        setGir('n');
                                    }
                                }
                                // If penalty is selected on par 4/5, auto-set fairway to No (penalty usually on tee shot)
                                if ((par === 4 || par === 5) && e.target.value && e.target.value !== '') {
                                    if (fairway === null || fairway === 'y') {
                                        setFairway('n');
                                    }
                                }
                            }}
                            className="w-full px-4 py-4 text-lg bg-[#DDEDD2] text-[#0a140a] border-2 border-[#DDEDD2] rounded-lg focus:outline-none focus:border-green-500"
                        >
                            <option value="">No Penalty</option>
                            <option value="ob">Out of Bounds (+1)</option>
                            <option value="water">Water Hazard (+1)</option>
                            <option value="lost">Lost Ball (+1)</option>
                            <option value="wrong">Wrong Ball (+2)</option>
                            <option value="other">Other (+1)</option>
                        </select>
                    </div>

                    {/* 3. Fairway - Known after drive (Par 4/5 only) */}
                    {par !== 3 && (
                        <div>
                            <label className="block text-base font-bold text-white mb-3">Fairway Hit?</label>
                            {penalty && penalty !== '' && (
                                <p className="text-sm text-yellow-300 mb-2">ℹ️ Penalty selected - usually means fairway missed. Change if penalty was on approach shot.</p>
                            )}
                            <div className="flex gap-3">
                                <button
                                    onClick={() => setFairway('y')}
                                    className={`flex-1 py-4 text-lg rounded-lg font-bold transition cursor-pointer ${
                                        fairway === 'y'
                                            ? 'bg-green-600 text-white shadow-lg ring-2 ring-green-400'
                                            : 'bg-[#DDEDD2] text-[#0a140a] hover:bg-green-100 hover:ring-2 hover:ring-green-300'
                                    }`}
                                >
                                    Yes
                                </button>
                                <button
                                    onClick={() => setFairway('n')}
                                    className={`flex-1 py-4 text-lg rounded-lg font-bold transition cursor-pointer ${
                                        fairway === 'n'
                                            ? 'bg-red-600 text-white shadow-lg ring-2 ring-red-400'
                                            : 'bg-[#DDEDD2] text-[#0a140a] hover:bg-red-100 hover:ring-2 hover:ring-red-300'
                                    }`}
                                >
                                    No
                                </button>
                            </div>
                        </div>
                    )}

                    {/* 4. GIR - Known after approach shot */}
                    <div>
                        <label className="block text-base font-bold text-white mb-3">Green in Regulation?</label>
                        {par === 3 && penalty && penalty !== '' && (
                            <p className="text-sm text-yellow-300 mb-2">⚠️ GIR not possible with a penalty on par 3</p>
                        )}
                        <div className="flex gap-3">
                            <button
                                onClick={() => setGir('y')}
                                disabled={par === 3 && penalty && penalty !== ''}
                                className={`flex-1 py-4 text-lg rounded-lg font-bold transition ${
                                    par === 3 && penalty && penalty !== ''
                                        ? 'bg-gray-600 text-gray-400 cursor-not-allowed opacity-50'
                                        : gir === 'y'
                                        ? 'bg-green-600 text-white shadow-lg ring-2 ring-green-400 cursor-pointer'
                                        : 'bg-[#DDEDD2] text-[#0a140a] hover:bg-green-100 hover:ring-2 hover:ring-green-300 cursor-pointer'
                                }`}
                            >
                                Yes
                            </button>
                            <button
                                onClick={() => setGir('n')}
                                className={`flex-1 py-4 text-lg rounded-lg font-bold transition cursor-pointer ${
                                    gir === 'n'
                                        ? 'bg-red-600 text-white shadow-lg ring-2 ring-red-400'
                                        : 'bg-[#DDEDD2] text-[#0a140a] hover:bg-red-100 hover:ring-2 hover:ring-red-300'
                                }`}
                            >
                                No
                            </button>
                        </div>
                    </div>

                    {/* 5. Shots to Green - Only if GIR = No */}
                    {gir === 'n' && (
                        <div>
                            <label className="block text-base font-bold text-white mb-2">Shots to Reach Green</label>
                            <input
                                type="number"
                                value={shotsToGreen}
                                onChange={(e) => {
                                    const val = e.target.value;
                                    // Allow empty string while typing, but preserve valid numbers
                                    if (val === '' || (!isNaN(val) && val >= 1)) {
                                        setShotsToGreen(val);
                                    }
                                }}
                                placeholder="Total shots before putting"
                                className="w-full px-4 py-4 text-lg bg-[#DDEDD2] text-[#0a140a] border-2 border-[#DDEDD2] rounded-lg focus:outline-none focus:border-green-500 placeholder-[#3d5a3d]"
                                min="1"
                            />
                            <p className="text-xs text-[#DDEDD2] mt-1">Total number of strokes to reach the green</p>
                        </div>
                    )}

                    {/* 6. Putts - Counted during putting */}
                    <div>
                        <label className="block text-base font-bold text-white mb-2">Number of Putts</label>
                        <input
                            type="number"
                            min="0"
                            max="10"
                            value={putts}
                            onChange={(e) => {
                                const val = e.target.value;
                                // Allow empty string while typing, but preserve the value
                                if (val === '' || (!isNaN(val) && val >= 0 && val <= 10)) {
                                    setPutts(val);
                                }
                            }}
                            onBlur={(e) => {
                                // On blur, if empty or invalid, don't change it (let validation catch it)
                                const val = e.target.value;
                                if (val !== '' && (isNaN(val) || val < 0 || val > 10)) {
                                    // Invalid value - reset to empty
                                    setPutts('');
                                }
                            }}
                            placeholder="e.g., 2"
                            className="w-full px-4 py-4 text-lg bg-[#DDEDD2] text-[#0a140a] border-2 border-[#DDEDD2] rounded-lg focus:outline-none focus:border-green-500 placeholder-[#3d5a3d]"
                        />
                    </div>

                    {/* 7. Approach Distance - Known when you reach the green */}
                    <div>
                        <label className="block text-base font-bold text-white mb-2">Approach Distance (feet)</label>
                        <input
                            type="number"
                            value={approachDistance}
                            onChange={(e) => setApproachDistance(e.target.value)}
                            placeholder="Distance from hole when putting"
                            className="w-full px-4 py-4 text-lg bg-[#DDEDD2] text-[#0a140a] border-2 border-[#DDEDD2] rounded-lg focus:outline-none focus:border-green-500 placeholder-[#3d5a3d]"
                            min="0"
                        />
                        <p className="text-xs text-[#DDEDD2] mt-1">Distance from the hole when you start putting</p>
                    </div>

                    {/* 8. Calculated Score Display */}
                    {(gir === 'y' && par && putts) || (gir === 'n' && shotsToGreen && putts) ? (
                        <div className="bg-[#1a2e1a] rounded-lg p-4 border-2 border-green-500">
                            <div className="text-center">
                                <div className="text-xs text-[#d1fae5] mb-1">Calculated Score</div>
                                <div className="text-4xl font-bold text-white">
                                    {(() => {
                                        const penaltyStrokes = penalty === 'wrong' ? 2 : penalty && penalty !== '' ? 1 : 0;
                                        if (gir === 'y' && par && putts) {
                                            return par + (parseInt(putts) - 2) + penaltyStrokes;
                                        } else if (gir === 'n' && shotsToGreen && putts) {
                                            return parseInt(shotsToGreen) + parseInt(putts) + penaltyStrokes;
                                        }
                                        return '-';
                                    })()}
                                </div>
                                <div className="text-sm text-[#DDEDD2] mt-1">
                                    {par && `Par ${par} • `}
                                    {(() => {
                                        const penaltyStrokes = penalty === 'wrong' ? 2 : penalty && penalty !== '' ? 1 : 0;
                                        if (gir === 'y' && par && putts) {
                                            const toPar = (par + (parseInt(putts) - 2) + penaltyStrokes) - par;
                                            return toPar === 0 ? 'Even' : toPar > 0 ? `+${toPar}` : toPar;
                                        } else if (gir === 'n' && shotsToGreen && putts && par) {
                                            const toPar = (parseInt(shotsToGreen) + parseInt(putts) + penaltyStrokes) - par;
                                            return toPar === 0 ? 'Even' : toPar > 0 ? `+${toPar}` : toPar;
                                        }
                                        return '';
                                    })()}
                                </div>
                            </div>
                        </div>
                    ) : null}


                    {/* Submit Button */}
                    <button
                        onClick={handleSubmit}
                        className="w-full bg-[#228B22] text-white py-4 text-lg rounded-lg font-bold hover:bg-[#1e7a1e] transition shadow-lg mb-4 cursor-pointer active:scale-[0.98]"
                    >
                        Record Hole #{holeNumber}
                    </button>
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GolfGIRTracker />);
        
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>