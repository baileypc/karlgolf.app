<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' data:; font-src 'self' data:; connect-src 'self' https://unpkg.com https://cdn.tailwindcss.com;">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Karl's GIR - Golf Tracker</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a140a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Karl's GIR">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/images/karls_gir.png">
    <link rel="apple-touch-icon" href="assets/images/karls_gir.png">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/main.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <!-- JavaScript Modules (load order matters) -->
    <script src="assets/js/db/storage.js"></script>
    <script src="assets/js/db/api.js"></script>
    <script src="assets/js/auth/auth-helpers.js"></script>
    <script src="assets/js/utils/analytics.js"></script>
    
    <!-- Pre-React initialization: Ensure login state is set synchronously -->
    <script>
        // Force localStorage check before React renders
        (function() {
            window.__karlsGIR_initialLoginState = Storage.getLoginState();
            console.log('Pre-React: Initial login state =', window.__karlsGIR_initialLoginState);
            
            // Track page visit
            if (typeof Analytics !== 'undefined') {
                Analytics.trackPageVisit('index.html');
            }
        })();
    </script>
    
    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Landing Page / Router Component
        function LandingPage() {
            const [isLoggedIn, setIsLoggedIn] = useState(() => {
                const fromGlobal = window.__karlsGIR_initialLoginState !== undefined 
                    ? window.__karlsGIR_initialLoginState 
                    : null;
                const fromStorage = Storage.getLoginState();
                return fromGlobal !== null ? fromGlobal : fromStorage;
            });
            const [showWelcomeModal, setShowWelcomeModal] = useState(() => {
                if (isLoggedIn) return false;
                const mode = Storage.getTrackingMode();
                const hasSeenWelcome = Storage.hasSeenWelcome();
                return !mode && !hasSeenWelcome;
            });
            const [expandedCards, setExpandedCards] = useState({
                existingUser: false,
                liveRound: false,
                createAccount: false
            });
            
            // Check login state on mount
            useEffect(() => {
                const checkLogin = () => {
                    setIsLoggedIn(Storage.getLoginState());
                };
                
                // Check immediately
                checkLogin();
                
                // Listen for storage changes (when user logs in/out in another tab)
                window.addEventListener('storage', checkLogin);
                
                // Also check periodically (in case localStorage is updated in same tab)
                const interval = setInterval(checkLogin, 1000);
                
                return () => {
                    window.removeEventListener('storage', checkLogin);
                    clearInterval(interval);
                };
            }, []);
            
            // Auto-redirect based on login state
            useEffect(() => {
                if (isLoggedIn) {
                    // Logged in - redirect to registered round tracker
                    Auth.redirectToTrackRound();
                } else {
                    // Not logged in - check if they've chosen a mode
                    const mode = Storage.getTrackingMode();
                    if (mode === 'LIVE_ROUND') {
                        // User has chosen live round - redirect to live tracker
                        window.location.href = 'track-live.html?t=' + Date.now();
                    } else {
                        // No mode set - show welcome modal (even if they've seen it before)
                        setShowWelcomeModal(true);
                    }
                }
            }, [isLoggedIn]);
            
            const handleTrackLiveRound = () => {
                Storage.setTrackingMode('LIVE_ROUND');
                Storage.setHasSeenWelcome(true);
                window.location.href = 'track-live.html?t=' + Date.now();
            };
            
            const handleCreateAccount = () => {
                sessionStorage.setItem('showRegister', 'true');
                window.location.href = 'login.html?t=' + Date.now();
            };
            
            const handleExistingUserLogin = () => {
                sessionStorage.removeItem('showRegister');
                window.location.href = 'login.html?t=' + Date.now();
            };
            
            const toggleCard = (cardKey) => {
                setExpandedCards(prev => ({
                    ...prev,
                    [cardKey]: !prev[cardKey]
                }));
            };
            
            return (
                <div className="min-h-screen bg-karl-bg-primary flex items-center justify-center p-4">
                    {/* Welcome Modal */}
                    {showWelcomeModal && (
                        <div className="modal-overlay">
                            <div className="modal-container" style={{maxWidth: '32rem'}}>
                                <div className="text-center mb-6">
                                    <a href="index.html" onClick={(e) => { e.preventDefault(); window.location.href = 'index.html?t=' + Date.now(); }} className="touch-target inline-block">
                                        <img src="assets/images/karls_gir.png" alt="Karl's GIR Logo" className="w-16 h-16 sm:w-20 sm:h-20 rounded-lg mx-auto mb-4" />
                                    </a>
                                    <h2 className="text-lg sm:text-xl font-bold text-karl-text-primary mb-2">Welcome to Karl's GIR</h2>
                                </div>
                                
                                <div className="space-y-3 sm:space-y-4 mb-6">
                                    <div className="w-full px-4 sm:px-6 py-3 sm:py-4 bg-karl-brown text-karl-dark rounded-lg font-semibold shadow-md border-2 border-karl-brown">
                                        <div className="flex items-center justify-between gap-2">
                                            <button
                                                onClick={handleExistingUserLogin}
                                                className="flex-1 text-left touch-target"
                                            >
                                                <div className="font-bold text-base sm:text-lg mb-1">Existing User Login</div>
                                            </button>
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    toggleCard('existingUser');
                                                }}
                                                className="touch-target p-2 rounded transition"
                                            >
                                                <svg 
                                                    width="24" 
                                                    height="24" 
                                                    viewBox="0 0 24 24" 
                                                    fill="none" 
                                                    stroke="currentColor" 
                                                    strokeWidth="2" 
                                                    strokeLinecap="round" 
                                                    strokeLinejoin="round"
                                                    className={`transition-transform duration-200 ${expandedCards.existingUser ? 'rotate-45' : ''}`}
                                                >
                                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                                </svg>
                                            </button>
                                        </div>
                                        {expandedCards.existingUser && (
                                            <div className="text-sm text-karl-dark opacity-70 mt-2 pt-2 border-t border-karl-dark border-opacity-20">
                                                Already have an account? Log in to access your dashboard, saved rounds, and statistics.
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className="w-full px-4 sm:px-6 py-3 sm:py-4 bg-karl-text-secondary text-karl-dark rounded-lg font-semibold shadow-md border-2 border-karl-border-primary">
                                        <div className="flex items-center justify-between gap-2">
                                            <button
                                                onClick={handleTrackLiveRound}
                                                className="flex-1 text-left touch-target"
                                            >
                                                <div className="font-bold text-base sm:text-lg mb-1">Track a Live Round</div>
                                            </button>
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    toggleCard('liveRound');
                                                }}
                                                className="touch-target p-2 rounded transition"
                                            >
                                                <svg 
                                                    width="24" 
                                                    height="24" 
                                                    viewBox="0 0 24 24" 
                                                    fill="none" 
                                                    stroke="currentColor" 
                                                    strokeWidth="2" 
                                                    strokeLinecap="round" 
                                                    strokeLinejoin="round"
                                                    className={`transition-transform duration-200 ${expandedCards.liveRound ? 'rotate-45' : ''}`}
                                                >
                                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                                </svg>
                                            </button>
                                        </div>
                                        {expandedCards.liveRound && (
                                            <div className="text-sm text-karl-dark opacity-70 mt-2 pt-2 border-t border-karl-dark border-opacity-20">
                                                Limited use: no dashboard, no round saving, no stats board. Perfect for quick tracking.
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className="w-full px-4 sm:px-6 py-3 sm:py-4 bg-karl-green text-karl-dark rounded-lg font-semibold shadow-md border-2 border-karl-green">
                                        <div className="flex items-center justify-between gap-2">
                                            <button
                                                onClick={handleCreateAccount}
                                                className="flex-1 text-left touch-target"
                                            >
                                                <div className="font-bold text-base sm:text-lg mb-1">Create an Account</div>
                                            </button>
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    toggleCard('createAccount');
                                                }}
                                                className="touch-target p-2 rounded transition"
                                            >
                                                <svg 
                                                    width="24" 
                                                    height="24" 
                                                    viewBox="0 0 24 24" 
                                                    fill="none" 
                                                    stroke="currentColor" 
                                                    strokeWidth="2" 
                                                    strokeLinecap="round" 
                                                    strokeLinejoin="round"
                                                    className={`transition-transform duration-200 ${expandedCards.createAccount ? 'rotate-45' : ''}`}
                                                >
                                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                                </svg>
                                            </button>
                                        </div>
                                        {expandedCards.createAccount && (
                                            <div className="text-sm text-karl-dark opacity-70 mt-2 pt-2 border-t border-karl-dark border-opacity-20">
                                                For serious players, students (high school and college). Build a GIR portfolio, average scoring, and game improvement stats.
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Fine Print Slogan */}
                                    <div className="mt-6 pt-4 border-t border-karl-border-primary border-opacity-20">
                                        <p className="text-xs sm:text-sm text-karl-text-primary text-center opacity-70 leading-relaxed">
                                            Built for students and serious golfersâ€”Karl's GIR makes tracking average score stats simple and powerful.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Loading State */}
                    {!showWelcomeModal && (
                        <div className="text-center">
                            <div className="loading-spinner mx-auto mb-4"></div>
                            <div className="text-karl-text-primary text-lg sm:text-xl">Loading...</div>
                        </div>
                    )}
                </div>
            );
        }
        
        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LandingPage />);
        
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
